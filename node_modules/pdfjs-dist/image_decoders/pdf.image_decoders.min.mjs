/**
 * @licstart The following is the entire license notice for the
 * JavaScript code in this page
 *
 * Copyright 2023 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * @licend The above is the entire license notice for the
 * JavaScript code in this page
 */var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t=globalThis.pdfjsImageDecoders={};e.d(t,{Jbig2Image:()=>Jbig2Image,JpegImage:()=>JpegImage,JpxImage:()=>JpxImage,getVerbosityLevel:()=>getVerbosityLevel,setVerbosityLevel:()=>setVerbosityLevel});"object"!=typeof process||process+""!="[object process]"||process.versions.nw||process.versions.electron&&process.type&&process.type;const n={ERRORS:0,WARNINGS:1,INFOS:5};let i=n.WARNINGS;function setVerbosityLevel(e){Number.isInteger(e)&&(i=e)}function getVerbosityLevel(){return i}function info(e){i>=n.INFOS&&console.log(`Info: ${e}`)}function util_warn(e){i>=n.WARNINGS&&console.log(`Warning: ${e}`)}function util_unreachable(e){throw new Error(e)}function util_shadow(e,t,n,i=!1){Object.defineProperty(e,t,{value:n,enumerable:!i,configurable:!0,writable:!1});return n}const s=function BaseExceptionClosure(){function BaseException(e,t){this.constructor===BaseException&&util_unreachable("Cannot initialize BaseException.");this.message=e;this.name=t}BaseException.prototype=new Error;BaseException.constructor=BaseException;return BaseException}();class FormatError extends s{constructor(e){super(e,"FormatError")}}class util_FeatureTest{static get isLittleEndian(){return util_shadow(this,"isLittleEndian",function isLittleEndian(){const e=new Uint8Array(4);e[0]=1;return 1===new Uint32Array(e.buffer,0,1)[0]}())}static get isEvalSupported(){return util_shadow(this,"isEvalSupported",function isEvalSupported(){try{new Function("");return!0}catch{return!1}}())}static get isOffscreenCanvasSupported(){return util_shadow(this,"isOffscreenCanvasSupported","undefined"!=typeof OffscreenCanvas)}static get platform(){return"undefined"!=typeof navigator&&"string"==typeof navigator?.platform?util_shadow(this,"platform",{isMac:navigator.platform.includes("Mac")}):util_shadow(this,"platform",{isMac:!1})}static get isCSSRoundSupported(){return util_shadow(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}[...Array(256).keys()].map((e=>e.toString(16).padStart(2,"0")));Symbol("CIRCULAR_REF"),Symbol("EOF");Object.create(null),Object.create(null),Object.create(null);Symbol.iterator;Symbol.iterator;function log2(e){return e<=0?0:Math.ceil(Math.log2(e))}function readInt8(e,t){return e[t]<<24>>24}function readUint16(e,t){return e[t]<<8|e[t+1]}function readUint32(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}const r=[{qe:22017,nmps:1,nlps:1,switchFlag:1},{qe:13313,nmps:2,nlps:6,switchFlag:0},{qe:6145,nmps:3,nlps:9,switchFlag:0},{qe:2753,nmps:4,nlps:12,switchFlag:0},{qe:1313,nmps:5,nlps:29,switchFlag:0},{qe:545,nmps:38,nlps:33,switchFlag:0},{qe:22017,nmps:7,nlps:6,switchFlag:1},{qe:21505,nmps:8,nlps:14,switchFlag:0},{qe:18433,nmps:9,nlps:14,switchFlag:0},{qe:14337,nmps:10,nlps:14,switchFlag:0},{qe:12289,nmps:11,nlps:17,switchFlag:0},{qe:9217,nmps:12,nlps:18,switchFlag:0},{qe:7169,nmps:13,nlps:20,switchFlag:0},{qe:5633,nmps:29,nlps:21,switchFlag:0},{qe:22017,nmps:15,nlps:14,switchFlag:1},{qe:21505,nmps:16,nlps:14,switchFlag:0},{qe:20737,nmps:17,nlps:15,switchFlag:0},{qe:18433,nmps:18,nlps:16,switchFlag:0},{qe:14337,nmps:19,nlps:17,switchFlag:0},{qe:13313,nmps:20,nlps:18,switchFlag:0},{qe:12289,nmps:21,nlps:19,switchFlag:0},{qe:10241,nmps:22,nlps:19,switchFlag:0},{qe:9217,nmps:23,nlps:20,switchFlag:0},{qe:8705,nmps:24,nlps:21,switchFlag:0},{qe:7169,nmps:25,nlps:22,switchFlag:0},{qe:6145,nmps:26,nlps:23,switchFlag:0},{qe:5633,nmps:27,nlps:24,switchFlag:0},{qe:5121,nmps:28,nlps:25,switchFlag:0},{qe:4609,nmps:29,nlps:26,switchFlag:0},{qe:4353,nmps:30,nlps:27,switchFlag:0},{qe:2753,nmps:31,nlps:28,switchFlag:0},{qe:2497,nmps:32,nlps:29,switchFlag:0},{qe:2209,nmps:33,nlps:30,switchFlag:0},{qe:1313,nmps:34,nlps:31,switchFlag:0},{qe:1089,nmps:35,nlps:32,switchFlag:0},{qe:673,nmps:36,nlps:33,switchFlag:0},{qe:545,nmps:37,nlps:34,switchFlag:0},{qe:321,nmps:38,nlps:35,switchFlag:0},{qe:273,nmps:39,nlps:36,switchFlag:0},{qe:133,nmps:40,nlps:37,switchFlag:0},{qe:73,nmps:41,nlps:38,switchFlag:0},{qe:37,nmps:42,nlps:39,switchFlag:0},{qe:21,nmps:43,nlps:40,switchFlag:0},{qe:9,nmps:44,nlps:41,switchFlag:0},{qe:5,nmps:45,nlps:42,switchFlag:0},{qe:1,nmps:45,nlps:43,switchFlag:0},{qe:22017,nmps:46,nlps:46,switchFlag:0}];class ArithmeticDecoder{constructor(e,t,n){this.data=e;this.bp=t;this.dataEnd=n;this.chigh=e[t];this.clow=0;this.byteIn();this.chigh=this.chigh<<7&65535|this.clow>>9&127;this.clow=this.clow<<7&65535;this.ct-=7;this.a=32768}byteIn(){const e=this.data;let t=this.bp;if(255===e[t])if(e[t+1]>143){this.clow+=65280;this.ct=8}else{t++;this.clow+=e[t]<<9;this.ct=7;this.bp=t}else{t++;this.clow+=t<this.dataEnd?e[t]<<8:65280;this.ct=8;this.bp=t}if(this.clow>65535){this.chigh+=this.clow>>16;this.clow&=65535}}readBit(e,t){let n=e[t]>>1,i=1&e[t];const s=r[n],o=s.qe;let a,c=this.a-o;if(this.chigh<o)if(c<o){c=o;a=i;n=s.nmps}else{c=o;a=1^i;1===s.switchFlag&&(i=a);n=s.nlps}else{this.chigh-=o;if(0!=(32768&c)){this.a=c;return i}if(c<o){a=1^i;1===s.switchFlag&&(i=a);n=s.nlps}else{a=i;n=s.nmps}}do{0===this.ct&&this.byteIn();c<<=1;this.chigh=this.chigh<<1&65535|this.clow>>15&1;this.clow=this.clow<<1&65535;this.ct--}while(0==(32768&c));this.a=c;e[t]=n<<1|i;return a}}const o=-1,a=[[-1,-1],[-1,-1],[7,8],[7,7],[6,6],[6,6],[6,5],[6,5],[4,0],[4,0],[4,0],[4,0],[4,0],[4,0],[4,0],[4,0],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[3,3],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2],[1,2]],c=[[-1,-1],[12,-2],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[11,1792],[11,1792],[12,1984],[12,2048],[12,2112],[12,2176],[12,2240],[12,2304],[11,1856],[11,1856],[11,1920],[11,1920],[12,2368],[12,2432],[12,2496],[12,2560]],l=[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[8,29],[8,29],[8,30],[8,30],[8,45],[8,45],[8,46],[8,46],[7,22],[7,22],[7,22],[7,22],[7,23],[7,23],[7,23],[7,23],[8,47],[8,47],[8,48],[8,48],[6,13],[6,13],[6,13],[6,13],[6,13],[6,13],[6,13],[6,13],[7,20],[7,20],[7,20],[7,20],[8,33],[8,33],[8,34],[8,34],[8,35],[8,35],[8,36],[8,36],[8,37],[8,37],[8,38],[8,38],[7,19],[7,19],[7,19],[7,19],[8,31],[8,31],[8,32],[8,32],[6,1],[6,1],[6,1],[6,1],[6,1],[6,1],[6,1],[6,1],[6,12],[6,12],[6,12],[6,12],[6,12],[6,12],[6,12],[6,12],[8,53],[8,53],[8,54],[8,54],[7,26],[7,26],[7,26],[7,26],[8,39],[8,39],[8,40],[8,40],[8,41],[8,41],[8,42],[8,42],[8,43],[8,43],[8,44],[8,44],[7,21],[7,21],[7,21],[7,21],[7,28],[7,28],[7,28],[7,28],[8,61],[8,61],[8,62],[8,62],[8,63],[8,63],[8,0],[8,0],[8,320],[8,320],[8,384],[8,384],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,10],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[5,11],[7,27],[7,27],[7,27],[7,27],[8,59],[8,59],[8,60],[8,60],[9,1472],[9,1536],[9,1600],[9,1728],[7,18],[7,18],[7,18],[7,18],[7,24],[7,24],[7,24],[7,24],[8,49],[8,49],[8,50],[8,50],[8,51],[8,51],[8,52],[8,52],[7,25],[7,25],[7,25],[7,25],[8,55],[8,55],[8,56],[8,56],[8,57],[8,57],[8,58],[8,58],[6,192],[6,192],[6,192],[6,192],[6,192],[6,192],[6,192],[6,192],[6,1664],[6,1664],[6,1664],[6,1664],[6,1664],[6,1664],[6,1664],[6,1664],[8,448],[8,448],[8,512],[8,512],[9,704],[9,768],[8,640],[8,640],[8,576],[8,576],[9,832],[9,896],[9,960],[9,1024],[9,1088],[9,1152],[9,1216],[9,1280],[9,1344],[9,1408],[7,256],[7,256],[7,256],[7,256],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,2],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[4,3],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,128],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,8],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[5,9],[6,16],[6,16],[6,16],[6,16],[6,16],[6,16],[6,16],[6,16],[6,17],[6,17],[6,17],[6,17],[6,17],[6,17],[6,17],[6,17],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,4],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[4,5],[6,14],[6,14],[6,14],[6,14],[6,14],[6,14],[6,14],[6,14],[6,15],[6,15],[6,15],[6,15],[6,15],[6,15],[6,15],[6,15],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[5,64],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,6],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7],[4,7]],h=[[-1,-1],[-1,-1],[12,-2],[12,-2],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[11,1792],[11,1792],[11,1792],[11,1792],[12,1984],[12,1984],[12,2048],[12,2048],[12,2112],[12,2112],[12,2176],[12,2176],[12,2240],[12,2240],[12,2304],[12,2304],[11,1856],[11,1856],[11,1856],[11,1856],[11,1920],[11,1920],[11,1920],[11,1920],[12,2368],[12,2368],[12,2432],[12,2432],[12,2496],[12,2496],[12,2560],[12,2560],[10,18],[10,18],[10,18],[10,18],[10,18],[10,18],[10,18],[10,18],[12,52],[12,52],[13,640],[13,704],[13,768],[13,832],[12,55],[12,55],[12,56],[12,56],[13,1280],[13,1344],[13,1408],[13,1472],[12,59],[12,59],[12,60],[12,60],[13,1536],[13,1600],[11,24],[11,24],[11,24],[11,24],[11,25],[11,25],[11,25],[11,25],[13,1664],[13,1728],[12,320],[12,320],[12,384],[12,384],[12,448],[12,448],[13,512],[13,576],[12,53],[12,53],[12,54],[12,54],[13,896],[13,960],[13,1024],[13,1088],[13,1152],[13,1216],[10,64],[10,64],[10,64],[10,64],[10,64],[10,64],[10,64],[10,64]],d=[[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[8,13],[11,23],[11,23],[12,50],[12,51],[12,44],[12,45],[12,46],[12,47],[12,57],[12,58],[12,61],[12,256],[10,16],[10,16],[10,16],[10,16],[10,17],[10,17],[10,17],[10,17],[12,48],[12,49],[12,62],[12,63],[12,30],[12,31],[12,32],[12,33],[12,40],[12,41],[11,22],[11,22],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[8,14],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,10],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[7,11],[9,15],[9,15],[9,15],[9,15],[9,15],[9,15],[9,15],[9,15],[12,128],[12,192],[12,26],[12,27],[12,28],[12,29],[11,19],[11,19],[11,20],[11,20],[12,34],[12,35],[12,36],[12,37],[12,38],[12,39],[11,21],[11,21],[12,42],[12,43],[10,0],[10,0],[10,0],[10,0],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12],[7,12]],f=[[-1,-1],[-1,-1],[-1,-1],[-1,-1],[6,9],[6,8],[5,7],[5,7],[4,6],[4,6],[4,6],[4,6],[4,5],[4,5],[4,5],[4,5],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,1],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[3,4],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,3],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2],[2,2]];class CCITTFaxDecoder{constructor(e,t={}){if(!e||"function"!=typeof e.next)throw new Error('CCITTFaxDecoder - invalid "source" parameter.');this.source=e;this.eof=!1;this.encoding=t.K||0;this.eoline=t.EndOfLine||!1;this.byteAlign=t.EncodedByteAlign||!1;this.columns=t.Columns||1728;this.rows=t.Rows||0;this.eoblock=t.EndOfBlock??!0;this.black=t.BlackIs1||!1;this.codingLine=new Uint32Array(this.columns+1);this.refLine=new Uint32Array(this.columns+2);this.codingLine[0]=this.columns;this.codingPos=0;this.row=0;this.nextLine2D=this.encoding<0;this.inputBits=0;this.inputBuf=0;this.outputBits=0;this.rowsDone=!1;let n;for(;0===(n=this._lookBits(12));)this._eatBits(1);1===n&&this._eatBits(12);if(this.encoding>0){this.nextLine2D=!this._lookBits(1);this._eatBits(1)}}readNextChar(){if(this.eof)return-1;const e=this.refLine,t=this.codingLine,n=this.columns;let i,s,r,a,c;if(0===this.outputBits){this.rowsDone&&(this.eof=!0);if(this.eof)return-1;this.err=!1;let r,c,l;if(this.nextLine2D){for(a=0;t[a]<n;++a)e[a]=t[a];e[a++]=n;e[a]=n;t[0]=0;this.codingPos=0;i=0;s=0;for(;t[this.codingPos]<n;){r=this._getTwoDimCode();switch(r){case 0:this._addPixels(e[i+1],s);e[i+1]<n&&(i+=2);break;case 1:r=c=0;if(s){do{r+=l=this._getBlackCode()}while(l>=64);do{c+=l=this._getWhiteCode()}while(l>=64)}else{do{r+=l=this._getWhiteCode()}while(l>=64);do{c+=l=this._getBlackCode()}while(l>=64)}this._addPixels(t[this.codingPos]+r,s);t[this.codingPos]<n&&this._addPixels(t[this.codingPos]+c,1^s);for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2;break;case 7:this._addPixels(e[i]+3,s);s^=1;if(t[this.codingPos]<n){++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 5:this._addPixels(e[i]+2,s);s^=1;if(t[this.codingPos]<n){++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 3:this._addPixels(e[i]+1,s);s^=1;if(t[this.codingPos]<n){++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 2:this._addPixels(e[i],s);s^=1;if(t[this.codingPos]<n){++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 8:this._addPixelsNeg(e[i]-3,s);s^=1;if(t[this.codingPos]<n){i>0?--i:++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 6:this._addPixelsNeg(e[i]-2,s);s^=1;if(t[this.codingPos]<n){i>0?--i:++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case 4:this._addPixelsNeg(e[i]-1,s);s^=1;if(t[this.codingPos]<n){i>0?--i:++i;for(;e[i]<=t[this.codingPos]&&e[i]<n;)i+=2}break;case o:this._addPixels(n,0);this.eof=!0;break;default:info("bad 2d code");this._addPixels(n,0);this.err=!0}}}else{t[0]=0;this.codingPos=0;s=0;for(;t[this.codingPos]<n;){r=0;if(s)do{r+=l=this._getBlackCode()}while(l>=64);else do{r+=l=this._getWhiteCode()}while(l>=64);this._addPixels(t[this.codingPos]+r,s);s^=1}}let h=!1;this.byteAlign&&(this.inputBits&=-8);if(this.eoblock||this.row!==this.rows-1){r=this._lookBits(12);if(this.eoline)for(;r!==o&&1!==r;){this._eatBits(1);r=this._lookBits(12)}else for(;0===r;){this._eatBits(1);r=this._lookBits(12)}if(1===r){this._eatBits(12);h=!0}else r===o&&(this.eof=!0)}else this.rowsDone=!0;if(!this.eof&&this.encoding>0&&!this.rowsDone){this.nextLine2D=!this._lookBits(1);this._eatBits(1)}if(this.eoblock&&h&&this.byteAlign){r=this._lookBits(12);if(1===r){this._eatBits(12);if(this.encoding>0){this._lookBits(1);this._eatBits(1)}if(this.encoding>=0)for(a=0;a<4;++a){r=this._lookBits(12);1!==r&&info("bad rtc code: "+r);this._eatBits(12);if(this.encoding>0){this._lookBits(1);this._eatBits(1)}}this.eof=!0}}else if(this.err&&this.eoline){for(;;){r=this._lookBits(13);if(r===o){this.eof=!0;return-1}if(r>>1==1)break;this._eatBits(1)}this._eatBits(12);if(this.encoding>0){this._eatBits(1);this.nextLine2D=!(1&r)}}this.outputBits=t[0]>0?t[this.codingPos=0]:t[this.codingPos=1];this.row++}if(this.outputBits>=8){c=1&this.codingPos?0:255;this.outputBits-=8;if(0===this.outputBits&&t[this.codingPos]<n){this.codingPos++;this.outputBits=t[this.codingPos]-t[this.codingPos-1]}}else{r=8;c=0;do{if("number"!=typeof this.outputBits)throw new FormatError('Invalid /CCITTFaxDecode data, "outputBits" must be a number.');if(this.outputBits>r){c<<=r;1&this.codingPos||(c|=255>>8-r);this.outputBits-=r;r=0}else{c<<=this.outputBits;1&this.codingPos||(c|=255>>8-this.outputBits);r-=this.outputBits;this.outputBits=0;if(t[this.codingPos]<n){this.codingPos++;this.outputBits=t[this.codingPos]-t[this.codingPos-1]}else if(r>0){c<<=r;r=0}}}while(r)}this.black&&(c^=255);return c}_addPixels(e,t){const n=this.codingLine;let i=this.codingPos;if(e>n[i]){if(e>this.columns){info("row is wrong length");this.err=!0;e=this.columns}1&i^t&&++i;n[i]=e}this.codingPos=i}_addPixelsNeg(e,t){const n=this.codingLine;let i=this.codingPos;if(e>n[i]){if(e>this.columns){info("row is wrong length");this.err=!0;e=this.columns}1&i^t&&++i;n[i]=e}else if(e<n[i]){if(e<0){info("invalid code");this.err=!0;e=0}for(;i>0&&e<n[i-1];)--i;n[i]=e}this.codingPos=i}_findTableCode(e,t,n,i){const s=i||0;for(let i=e;i<=t;++i){let e=this._lookBits(i);if(e===o)return[!0,1,!1];i<t&&(e<<=t-i);if(!s||e>=s){const t=n[e-s];if(t[0]===i){this._eatBits(i);return[!0,t[1],!0]}}}return[!1,0,!1]}_getTwoDimCode(){let e,t=0;if(this.eoblock){t=this._lookBits(7);e=a[t];if(e?.[0]>0){this._eatBits(e[0]);return e[1]}}else{const e=this._findTableCode(1,7,a);if(e[0]&&e[2])return e[1]}info("Bad two dim code");return o}_getWhiteCode(){let e,t=0;if(this.eoblock){t=this._lookBits(12);if(t===o)return 1;e=t>>5==0?c[t]:l[t>>3];if(e[0]>0){this._eatBits(e[0]);return e[1]}}else{let e=this._findTableCode(1,9,l);if(e[0])return e[1];e=this._findTableCode(11,12,c);if(e[0])return e[1]}info("bad white code");this._eatBits(1);return 1}_getBlackCode(){let e,t;if(this.eoblock){e=this._lookBits(13);if(e===o)return 1;t=e>>7==0?h[e]:e>>9==0&&e>>7!=0?d[(e>>1)-64]:f[e>>7];if(t[0]>0){this._eatBits(t[0]);return t[1]}}else{let e=this._findTableCode(2,6,f);if(e[0])return e[1];e=this._findTableCode(7,12,d,64);if(e[0])return e[1];e=this._findTableCode(10,13,h);if(e[0])return e[1]}info("bad black code");this._eatBits(1);return 1}_lookBits(e){let t;for(;this.inputBits<e;){if(-1===(t=this.source.next()))return 0===this.inputBits?o:this.inputBuf<<e-this.inputBits&65535>>16-e;this.inputBuf=this.inputBuf<<8|t;this.inputBits+=8}return this.inputBuf>>this.inputBits-e&65535>>16-e}_eatBits(e){(this.inputBits-=e)<0&&(this.inputBits=0)}}class Jbig2Error extends s{constructor(e){super(`JBIG2 error: ${e}`,"Jbig2Error")}}class ContextCache{getContexts(e){return e in this?this[e]:this[e]=new Int8Array(65536)}}class DecodingContext{constructor(e,t,n){this.data=e;this.start=t;this.end=n}get decoder(){return util_shadow(this,"decoder",new ArithmeticDecoder(this.data,this.start,this.end))}get contextCache(){return util_shadow(this,"contextCache",new ContextCache)}}const u=2**31-1,m=-(2**31);function decodeInteger(e,t,n){const i=e.getContexts(t);let s=1;function readBits(e){let t=0;for(let r=0;r<e;r++){const e=n.readBit(i,s);s=s<256?s<<1|e:511&(s<<1|e)|256;t=t<<1|e}return t>>>0}const r=readBits(1),o=readBits(1)?readBits(1)?readBits(1)?readBits(1)?readBits(1)?readBits(32)+4436:readBits(12)+340:readBits(8)+84:readBits(6)+20:readBits(4)+4:readBits(2);let a;0===r?a=o:o>0&&(a=-o);return a>=m&&a<=u?a:null}function decodeIAID(e,t,n){const i=e.getContexts("IAID");let s=1;for(let e=0;e<n;e++){s=s<<1|t.readBit(i,s)}return n<31?s&(1<<n)-1:2147483647&s}const g=["SymbolDictionary",null,null,null,"IntermediateTextRegion",null,"ImmediateTextRegion","ImmediateLosslessTextRegion",null,null,null,null,null,null,null,null,"PatternDictionary",null,null,null,"IntermediateHalftoneRegion",null,"ImmediateHalftoneRegion","ImmediateLosslessHalftoneRegion",null,null,null,null,null,null,null,null,null,null,null,null,"IntermediateGenericRegion",null,"ImmediateGenericRegion","ImmediateLosslessGenericRegion","IntermediateGenericRefinementRegion",null,"ImmediateGenericRefinementRegion","ImmediateLosslessGenericRefinementRegion",null,null,null,null,"PageInformation","EndOfPage","EndOfStripe","EndOfFile","Profiles","Tables",null,null,null,null,null,null,null,null,"Extension"],p=[[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:2,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:2,y:-1},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}],[{x:-1,y:-2},{x:0,y:-2},{x:1,y:-2},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-2,y:0},{x:-1,y:0}],[{x:-3,y:-1},{x:-2,y:-1},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-4,y:0},{x:-3,y:0},{x:-2,y:0},{x:-1,y:0}]],b=[{coding:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:1,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:-1,y:1},{x:0,y:1},{x:1,y:1}]},{coding:[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:-1,y:0}],reference:[{x:0,y:-1},{x:-1,y:0},{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]}],x=[39717,1941,229,405],w=[32,8];function decodeBitmap(e,t,n,i,s,r,o,a){if(e){return decodeMMRBitmap(new Reader(a.data,a.start,a.end),t,n,!1)}if(0===i&&!r&&!s&&4===o.length&&3===o[0].x&&-1===o[0].y&&-3===o[1].x&&-1===o[1].y&&2===o[2].x&&-2===o[2].y&&-2===o[3].x&&-2===o[3].y)return function decodeBitmapTemplate0(e,t,n){const i=n.decoder,s=n.contextCache.getContexts("GB"),r=[];let o,a,c,l,h,d,f;for(a=0;a<t;a++){h=r[a]=new Uint8Array(e);d=a<1?h:r[a-1];f=a<2?h:r[a-2];o=f[0]<<13|f[1]<<12|f[2]<<11|d[0]<<7|d[1]<<6|d[2]<<5|d[3]<<4;for(c=0;c<e;c++){h[c]=l=i.readBit(s,o);o=(31735&o)<<1|(c+3<e?f[c+3]<<11:0)|(c+4<e?d[c+4]<<4:0)|l}}return r}(t,n,a);const c=!!r,l=p[i].concat(o);l.sort((function(e,t){return e.y-t.y||e.x-t.x}));const h=l.length,d=new Int8Array(h),f=new Int8Array(h),u=[];let m,g,b=0,w=0,y=0,k=0;for(g=0;g<h;g++){d[g]=l[g].x;f[g]=l[g].y;w=Math.min(w,l[g].x);y=Math.max(y,l[g].x);k=Math.min(k,l[g].y);g<h-1&&l[g].y===l[g+1].y&&l[g].x===l[g+1].x-1?b|=1<<h-1-g:u.push(g)}const C=u.length,I=new Int8Array(C),B=new Int8Array(C),P=new Uint16Array(C);for(m=0;m<C;m++){g=u[m];I[m]=l[g].x;B[m]=l[g].y;P[m]=1<<h-1-g}const T=-w,S=-k,L=t-y,v=x[i];let M=new Uint8Array(t);const _=[],D=a.decoder,E=a.contextCache.getContexts("GB");let U,A,O,R,H,F=0,z=0;for(let e=0;e<n;e++){if(s){F^=D.readBit(E,v);if(F){_.push(M);continue}}M=new Uint8Array(M);_.push(M);for(U=0;U<t;U++){if(c&&r[e][U]){M[U]=0;continue}if(U>=T&&U<L&&e>=S){z=z<<1&b;for(g=0;g<C;g++){A=e+B[g];O=U+I[g];R=_[A][O];if(R){R=P[g];z|=R}}}else{z=0;H=h-1;for(g=0;g<h;g++,H--){O=U+d[g];if(O>=0&&O<t){A=e+f[g];if(A>=0){R=_[A][O];R&&(z|=R<<H)}}}}const n=D.readBit(E,z);M[U]=n}}return _}function decodeRefinement(e,t,n,i,s,r,o,a,c){let l=b[n].coding;0===n&&(l=l.concat([a[0]]));const h=l.length,d=new Int32Array(h),f=new Int32Array(h);let u;for(u=0;u<h;u++){d[u]=l[u].x;f[u]=l[u].y}let m=b[n].reference;0===n&&(m=m.concat([a[1]]));const g=m.length,p=new Int32Array(g),x=new Int32Array(g);for(u=0;u<g;u++){p[u]=m[u].x;x[u]=m[u].y}const y=i[0].length,k=i.length,C=w[n],I=[],B=c.decoder,P=c.contextCache.getContexts("GR");let T=0;for(let n=0;n<t;n++){if(o){T^=B.readBit(P,C);if(T)throw new Jbig2Error("prediction is not supported")}const t=new Uint8Array(e);I.push(t);for(let o=0;o<e;o++){let a,c,l=0;for(u=0;u<h;u++){a=n+f[u];c=o+d[u];a<0||c<0||c>=e?l<<=1:l=l<<1|I[a][c]}for(u=0;u<g;u++){a=n+x[u]-r;c=o+p[u]-s;a<0||a>=k||c<0||c>=y?l<<=1:l=l<<1|i[a][c]}const m=B.readBit(P,l);t[o]=m}}return I}function decodeTextRegion(e,t,n,i,s,r,o,a,c,l,h,d,f,u,m,g,p,b,x){if(e&&t)throw new Jbig2Error("refinement with Huffman is not supported");const w=[];let y,k;for(y=0;y<i;y++){k=new Uint8Array(n);if(s)for(let e=0;e<n;e++)k[e]=s;w.push(k)}const C=p.decoder,I=p.contextCache;let B=e?-u.tableDeltaT.decode(x):-decodeInteger(I,"IADT",C),P=0;y=0;for(;y<r;){B+=e?u.tableDeltaT.decode(x):decodeInteger(I,"IADT",C);P+=e?u.tableFirstS.decode(x):decodeInteger(I,"IAFS",C);let i=P;for(;;){let s=0;o>1&&(s=e?x.readBits(b):decodeInteger(I,"IAIT",C));const r=o*B+s,P=e?u.symbolIDTable.decode(x):decodeIAID(I,C,c),T=t&&(e?x.readBit():decodeInteger(I,"IARI",C));let S=a[P],L=S[0].length,v=S.length;if(T){const e=decodeInteger(I,"IARDW",C),t=decodeInteger(I,"IARDH",C);L+=e;v+=t;S=decodeRefinement(L,v,m,S,(e>>1)+decodeInteger(I,"IARDX",C),(t>>1)+decodeInteger(I,"IARDY",C),!1,g,p)}const M=r-(1&d?0:v-1),_=i-(2&d?L-1:0);let D,E,U;if(l){for(D=0;D<v;D++){k=w[_+D];if(!k)continue;U=S[D];const e=Math.min(n-M,L);switch(f){case 0:for(E=0;E<e;E++)k[M+E]|=U[E];break;case 2:for(E=0;E<e;E++)k[M+E]^=U[E];break;default:throw new Jbig2Error(`operator ${f} is not supported`)}}i+=v-1}else{for(E=0;E<v;E++){k=w[M+E];if(k){U=S[E];switch(f){case 0:for(D=0;D<L;D++)k[_+D]|=U[D];break;case 2:for(D=0;D<L;D++)k[_+D]^=U[D];break;default:throw new Jbig2Error(`operator ${f} is not supported`)}}}i+=L-1}y++;const A=e?u.tableDeltaS.decode(x):decodeInteger(I,"IADS",C);if(null===A)break;i+=A+h}}return w}function readSegmentHeader(e,t){const n={};n.number=readUint32(e,t);const i=e[t+4],s=63&i;if(!g[s])throw new Jbig2Error("invalid segment type: "+s);n.type=s;n.typeName=g[s];n.deferredNonRetain=!!(128&i);const r=!!(64&i),o=e[t+5];let a=o>>5&7;const c=[31&o];let l=t+6;if(7===o){a=536870911&readUint32(e,l-1);l+=3;let t=a+7>>3;c[0]=e[l++];for(;--t>0;)c.push(e[l++])}else if(5===o||6===o)throw new Jbig2Error("invalid referred-to flags");n.retainBits=c;let h=4;n.number<=256?h=1:n.number<=65536&&(h=2);const d=[];let f,u;for(f=0;f<a;f++){let t;t=1===h?e[l]:2===h?readUint16(e,l):readUint32(e,l);d.push(t);l+=h}n.referredTo=d;if(r){n.pageAssociation=readUint32(e,l);l+=4}else n.pageAssociation=e[l++];n.length=readUint32(e,l);l+=4;if(4294967295===n.length){if(38!==s)throw new Jbig2Error("invalid unknown segment length");{const t=readRegionSegmentInformation(e,l),i=!!(1&e[l+y]),s=6,r=new Uint8Array(s);if(!i){r[0]=255;r[1]=172}r[2]=t.height>>>24&255;r[3]=t.height>>16&255;r[4]=t.height>>8&255;r[5]=255&t.height;for(f=l,u=e.length;f<u;f++){let t=0;for(;t<s&&r[t]===e[f+t];)t++;if(t===s){n.length=f+s;break}}if(4294967295===n.length)throw new Jbig2Error("segment end was not found")}}n.headerEnd=l;return n}function readSegments(e,t,n,i){const s=[];let r=n;for(;r<i;){const n=readSegmentHeader(t,r);r=n.headerEnd;const i={header:n,data:t};if(!e.randomAccess){i.start=r;r+=n.length;i.end=r}s.push(i);if(51===n.type)break}if(e.randomAccess)for(let e=0,t=s.length;e<t;e++){s[e].start=r;r+=s[e].header.length;s[e].end=r}return s}function readRegionSegmentInformation(e,t){return{width:readUint32(e,t),height:readUint32(e,t+4),x:readUint32(e,t+8),y:readUint32(e,t+12),combinationOperator:7&e[t+16]}}const y=17;function processSegment(e,t){const n=e.header,i=e.data,s=e.end;let r,o,a,c,l=e.start;switch(n.type){case 0:const e={},t=readUint16(i,l);e.huffman=!!(1&t);e.refinement=!!(2&t);e.huffmanDHSelector=t>>2&3;e.huffmanDWSelector=t>>4&3;e.bitmapSizeSelector=t>>6&1;e.aggregationInstancesSelector=t>>7&1;e.bitmapCodingContextUsed=!!(256&t);e.bitmapCodingContextRetained=!!(512&t);e.template=t>>10&3;e.refinementTemplate=t>>12&1;l+=2;if(!e.huffman){c=0===e.template?4:1;o=[];for(a=0;a<c;a++){o.push({x:readInt8(i,l),y:readInt8(i,l+1)});l+=2}e.at=o}if(e.refinement&&!e.refinementTemplate){o=[];for(a=0;a<2;a++){o.push({x:readInt8(i,l),y:readInt8(i,l+1)});l+=2}e.refinementAt=o}e.numberOfExportedSymbols=readUint32(i,l);l+=4;e.numberOfNewSymbols=readUint32(i,l);l+=4;r=[e,n.number,n.referredTo,i,l,s];break;case 6:case 7:const h={};h.info=readRegionSegmentInformation(i,l);l+=y;const d=readUint16(i,l);l+=2;h.huffman=!!(1&d);h.refinement=!!(2&d);h.logStripSize=d>>2&3;h.stripSize=1<<h.logStripSize;h.referenceCorner=d>>4&3;h.transposed=!!(64&d);h.combinationOperator=d>>7&3;h.defaultPixelValue=d>>9&1;h.dsOffset=d<<17>>27;h.refinementTemplate=d>>15&1;if(h.huffman){const e=readUint16(i,l);l+=2;h.huffmanFS=3&e;h.huffmanDS=e>>2&3;h.huffmanDT=e>>4&3;h.huffmanRefinementDW=e>>6&3;h.huffmanRefinementDH=e>>8&3;h.huffmanRefinementDX=e>>10&3;h.huffmanRefinementDY=e>>12&3;h.huffmanRefinementSizeSelector=!!(16384&e)}if(h.refinement&&!h.refinementTemplate){o=[];for(a=0;a<2;a++){o.push({x:readInt8(i,l),y:readInt8(i,l+1)});l+=2}h.refinementAt=o}h.numberOfSymbolInstances=readUint32(i,l);l+=4;r=[h,n.referredTo,i,l,s];break;case 16:const f={},u=i[l++];f.mmr=!!(1&u);f.template=u>>1&3;f.patternWidth=i[l++];f.patternHeight=i[l++];f.maxPatternIndex=readUint32(i,l);l+=4;r=[f,n.number,i,l,s];break;case 22:case 23:const m={};m.info=readRegionSegmentInformation(i,l);l+=y;const g=i[l++];m.mmr=!!(1&g);m.template=g>>1&3;m.enableSkip=!!(8&g);m.combinationOperator=g>>4&7;m.defaultPixelValue=g>>7&1;m.gridWidth=readUint32(i,l);l+=4;m.gridHeight=readUint32(i,l);l+=4;m.gridOffsetX=4294967295&readUint32(i,l);l+=4;m.gridOffsetY=4294967295&readUint32(i,l);l+=4;m.gridVectorX=readUint16(i,l);l+=2;m.gridVectorY=readUint16(i,l);l+=2;r=[m,n.referredTo,i,l,s];break;case 38:case 39:const p={};p.info=readRegionSegmentInformation(i,l);l+=y;const b=i[l++];p.mmr=!!(1&b);p.template=b>>1&3;p.prediction=!!(8&b);if(!p.mmr){c=0===p.template?4:1;o=[];for(a=0;a<c;a++){o.push({x:readInt8(i,l),y:readInt8(i,l+1)});l+=2}p.at=o}r=[p,i,l,s];break;case 48:const x={width:readUint32(i,l),height:readUint32(i,l+4),resolutionX:readUint32(i,l+8),resolutionY:readUint32(i,l+12)};4294967295===x.height&&delete x.height;const w=i[l+16];readUint16(i,l+17);x.lossless=!!(1&w);x.refinement=!!(2&w);x.defaultPixelValue=w>>2&1;x.combinationOperator=w>>3&3;x.requiresBuffer=!!(32&w);x.combinationOperatorOverride=!!(64&w);r=[x];break;case 49:case 50:case 51:case 62:break;case 53:r=[n.number,i,l,s];break;default:throw new Jbig2Error(`segment type ${n.typeName}(${n.type}) is not implemented`)}const h="on"+n.typeName;h in t&&t[h].apply(t,r)}function processSegments(e,t){for(let n=0,i=e.length;n<i;n++)processSegment(e[n],t)}class SimpleSegmentVisitor{onPageInformation(e){this.currentPageInfo=e;const t=e.width+7>>3,n=new Uint8ClampedArray(t*e.height);e.defaultPixelValue&&n.fill(255);this.buffer=n}drawBitmap(e,t){const n=this.currentPageInfo,i=e.width,s=e.height,r=n.width+7>>3,o=n.combinationOperatorOverride?e.combinationOperator:n.combinationOperator,a=this.buffer,c=128>>(7&e.x);let l,h,d,f,u=e.y*r+(e.x>>3);switch(o){case 0:for(l=0;l<s;l++){d=c;f=u;for(h=0;h<i;h++){t[l][h]&&(a[f]|=d);d>>=1;if(!d){d=128;f++}}u+=r}break;case 2:for(l=0;l<s;l++){d=c;f=u;for(h=0;h<i;h++){t[l][h]&&(a[f]^=d);d>>=1;if(!d){d=128;f++}}u+=r}break;default:throw new Jbig2Error(`operator ${o} is not supported`)}}onImmediateGenericRegion(e,t,n,i){const s=e.info,r=new DecodingContext(t,n,i),o=decodeBitmap(e.mmr,s.width,s.height,e.template,e.prediction,null,e.at,r);this.drawBitmap(s,o)}onImmediateLosslessGenericRegion(){this.onImmediateGenericRegion(...arguments)}onSymbolDictionary(e,t,n,i,s,r){let o,a;if(e.huffman){o=function getSymbolDictionaryHuffmanTables(e,t,n){let i,s,r,o,a=0;switch(e.huffmanDHSelector){case 0:case 1:i=getStandardTable(e.huffmanDHSelector+4);break;case 3:i=getCustomHuffmanTable(a,t,n);a++;break;default:throw new Jbig2Error("invalid Huffman DH selector")}switch(e.huffmanDWSelector){case 0:case 1:s=getStandardTable(e.huffmanDWSelector+2);break;case 3:s=getCustomHuffmanTable(a,t,n);a++;break;default:throw new Jbig2Error("invalid Huffman DW selector")}if(e.bitmapSizeSelector){r=getCustomHuffmanTable(a,t,n);a++}else r=getStandardTable(1);o=e.aggregationInstancesSelector?getCustomHuffmanTable(a,t,n):getStandardTable(1);return{tableDeltaHeight:i,tableDeltaWidth:s,tableBitmapSize:r,tableAggregateInstances:o}}(e,n,this.customTables);a=new Reader(i,s,r)}let c=this.symbols;c||(this.symbols=c={});const l=[];for(const e of n){const t=c[e];t&&l.push(...t)}const h=new DecodingContext(i,s,r);c[t]=function decodeSymbolDictionary(e,t,n,i,s,r,o,a,c,l,h,d){if(e&&t)throw new Jbig2Error("symbol refinement with Huffman is not supported");const f=[];let u=0,m=log2(n.length+i);const g=h.decoder,p=h.contextCache;let b,x;if(e){b=getStandardTable(1);x=[];m=Math.max(m,1)}for(;f.length<i;){u+=e?r.tableDeltaHeight.decode(d):decodeInteger(p,"IADH",g);let i=0,s=0;const b=e?x.length:0;for(;;){const b=e?r.tableDeltaWidth.decode(d):decodeInteger(p,"IADW",g);if(null===b)break;i+=b;s+=i;let w;if(t){const s=decodeInteger(p,"IAAI",g);if(s>1)w=decodeTextRegion(e,t,i,u,0,s,1,n.concat(f),m,0,0,1,0,r,c,l,h,0,d);else{const e=decodeIAID(p,g,m),t=decodeInteger(p,"IARDX",g),s=decodeInteger(p,"IARDY",g);w=decodeRefinement(i,u,c,e<n.length?n[e]:f[e-n.length],t,s,!1,l,h)}f.push(w)}else if(e)x.push(i);else{w=decodeBitmap(!1,i,u,o,!1,null,a,h);f.push(w)}}if(e&&!t){const e=r.tableBitmapSize.decode(d);d.byteAlign();let t;if(0===e)t=readUncompressedBitmap(d,s,u);else{const n=d.end,i=d.position+e;d.end=i;t=decodeMMRBitmap(d,s,u,!1);d.end=n;d.position=i}const n=x.length;if(b===n-1)f.push(t);else{let e,i,s,r,o,a=0;for(e=b;e<n;e++){r=x[e];s=a+r;o=[];for(i=0;i<u;i++)o.push(t[i].subarray(a,s));f.push(o);a=s}}}}const w=[],y=[];let k,C,I=!1;const B=n.length+i;for(;y.length<B;){let t=e?b.decode(d):decodeInteger(p,"IAEX",g);for(;t--;)y.push(I);I=!I}for(k=0,C=n.length;k<C;k++)y[k]&&w.push(n[k]);for(let e=0;e<i;k++,e++)y[k]&&w.push(f[e]);return w}(e.huffman,e.refinement,l,e.numberOfNewSymbols,e.numberOfExportedSymbols,o,e.template,e.at,e.refinementTemplate,e.refinementAt,h,a)}onImmediateTextRegion(e,t,n,i,s){const r=e.info;let o,a;const c=this.symbols,l=[];for(const e of t){const t=c[e];t&&l.push(...t)}const h=log2(l.length);if(e.huffman){a=new Reader(n,i,s);o=function getTextRegionHuffmanTables(e,t,n,i,s){const r=[];for(let e=0;e<=34;e++){const t=s.readBits(4);r.push(new HuffmanLine([e,t,0,0]))}const o=new HuffmanTable(r,!1);r.length=0;for(let e=0;e<i;){const t=o.decode(s);if(t>=32){let n,i,o;switch(t){case 32:if(0===e)throw new Jbig2Error("no previous value in symbol ID table");i=s.readBits(2)+3;n=r[e-1].prefixLength;break;case 33:i=s.readBits(3)+3;n=0;break;case 34:i=s.readBits(7)+11;n=0;break;default:throw new Jbig2Error("invalid code length in symbol ID table")}for(o=0;o<i;o++){r.push(new HuffmanLine([e,n,0,0]));e++}}else{r.push(new HuffmanLine([e,t,0,0]));e++}}s.byteAlign();const a=new HuffmanTable(r,!1);let c,l,h,d=0;switch(e.huffmanFS){case 0:case 1:c=getStandardTable(e.huffmanFS+6);break;case 3:c=getCustomHuffmanTable(d,t,n);d++;break;default:throw new Jbig2Error("invalid Huffman FS selector")}switch(e.huffmanDS){case 0:case 1:case 2:l=getStandardTable(e.huffmanDS+8);break;case 3:l=getCustomHuffmanTable(d,t,n);d++;break;default:throw new Jbig2Error("invalid Huffman DS selector")}switch(e.huffmanDT){case 0:case 1:case 2:h=getStandardTable(e.huffmanDT+11);break;case 3:h=getCustomHuffmanTable(d,t,n);d++;break;default:throw new Jbig2Error("invalid Huffman DT selector")}if(e.refinement)throw new Jbig2Error("refinement with Huffman is not supported");return{symbolIDTable:a,tableFirstS:c,tableDeltaS:l,tableDeltaT:h}}(e,t,this.customTables,l.length,a)}const d=new DecodingContext(n,i,s),f=decodeTextRegion(e.huffman,e.refinement,r.width,r.height,e.defaultPixelValue,e.numberOfSymbolInstances,e.stripSize,l,h,e.transposed,e.dsOffset,e.referenceCorner,e.combinationOperator,o,e.refinementTemplate,e.refinementAt,d,e.logStripSize,a);this.drawBitmap(r,f)}onImmediateLosslessTextRegion(){this.onImmediateTextRegion(...arguments)}onPatternDictionary(e,t,n,i,s){let r=this.patterns;r||(this.patterns=r={});const o=new DecodingContext(n,i,s);r[t]=function decodePatternDictionary(e,t,n,i,s,r){const o=[];if(!e){o.push({x:-t,y:0});0===s&&o.push({x:-3,y:-1},{x:2,y:-2},{x:-2,y:-2})}const a=decodeBitmap(e,(i+1)*t,n,s,!1,null,o,r),c=[];for(let e=0;e<=i;e++){const i=[],s=t*e,r=s+t;for(let e=0;e<n;e++)i.push(a[e].subarray(s,r));c.push(i)}return c}(e.mmr,e.patternWidth,e.patternHeight,e.maxPatternIndex,e.template,o)}onImmediateHalftoneRegion(e,t,n,i,s){const r=this.patterns[t[0]],o=e.info,a=new DecodingContext(n,i,s),c=function decodeHalftoneRegion(e,t,n,i,s,r,o,a,c,l,h,d,f,u,m){if(o)throw new Jbig2Error("skip is not supported");if(0!==a)throw new Jbig2Error(`operator "${a}" is not supported in halftone region`);const g=[];let p,b,x;for(p=0;p<s;p++){x=new Uint8Array(i);if(r)for(b=0;b<i;b++)x[b]=r;g.push(x)}const w=t.length,y=t[0],k=y[0].length,C=y.length,I=log2(w),B=[];if(!e){B.push({x:n<=1?3:2,y:-1});0===n&&B.push({x:-3,y:-1},{x:2,y:-2},{x:-2,y:-2})}const P=[];let T,S,L,v,M,_,D,E,U,A,O;e&&(T=new Reader(m.data,m.start,m.end));for(p=I-1;p>=0;p--){S=e?decodeMMRBitmap(T,c,l,!0):decodeBitmap(!1,c,l,n,!1,null,B,m);P[p]=S}for(L=0;L<l;L++)for(v=0;v<c;v++){M=0;_=0;for(b=I-1;b>=0;b--){M^=P[b][L][v];_|=M<<b}D=t[_];E=h+L*u+v*f>>8;U=d+L*f-v*u>>8;if(E>=0&&E+k<=i&&U>=0&&U+C<=s)for(p=0;p<C;p++){O=g[U+p];A=D[p];for(b=0;b<k;b++)O[E+b]|=A[b]}else{let e,t;for(p=0;p<C;p++){t=U+p;if(!(t<0||t>=s)){O=g[t];A=D[p];for(b=0;b<k;b++){e=E+b;e>=0&&e<i&&(O[e]|=A[b])}}}}}return g}(e.mmr,r,e.template,o.width,o.height,e.defaultPixelValue,e.enableSkip,e.combinationOperator,e.gridWidth,e.gridHeight,e.gridOffsetX,e.gridOffsetY,e.gridVectorX,e.gridVectorY,a);this.drawBitmap(o,c)}onImmediateLosslessHalftoneRegion(){this.onImmediateHalftoneRegion(...arguments)}onTables(e,t,n,i){let s=this.customTables;s||(this.customTables=s={});s[e]=function decodeTablesSegment(e,t,n){const i=e[t],s=4294967295&readUint32(e,t+1),r=4294967295&readUint32(e,t+5),o=new Reader(e,t+9,n),a=1+(i>>1&7),c=1+(i>>4&7),l=[];let h,d,f=s;do{h=o.readBits(a);d=o.readBits(c);l.push(new HuffmanLine([f,h,d,0]));f+=1<<d}while(f<r);h=o.readBits(a);l.push(new HuffmanLine([s-1,h,32,0,"lower"]));h=o.readBits(a);l.push(new HuffmanLine([r,h,32,0]));if(1&i){h=o.readBits(a);l.push(new HuffmanLine([h,0]))}return new HuffmanTable(l,!1)}(t,n,i)}}class HuffmanLine{constructor(e){if(2===e.length){this.isOOB=!0;this.rangeLow=0;this.prefixLength=e[0];this.rangeLength=0;this.prefixCode=e[1];this.isLowerRange=!1}else{this.isOOB=!1;this.rangeLow=e[0];this.prefixLength=e[1];this.rangeLength=e[2];this.prefixCode=e[3];this.isLowerRange="lower"===e[4]}}}class HuffmanTreeNode{constructor(e){this.children=[];if(e){this.isLeaf=!0;this.rangeLength=e.rangeLength;this.rangeLow=e.rangeLow;this.isLowerRange=e.isLowerRange;this.isOOB=e.isOOB}else this.isLeaf=!1}buildTree(e,t){const n=e.prefixCode>>t&1;if(t<=0)this.children[n]=new HuffmanTreeNode(e);else{let i=this.children[n];i||(this.children[n]=i=new HuffmanTreeNode(null));i.buildTree(e,t-1)}}decodeNode(e){if(this.isLeaf){if(this.isOOB)return null;const t=e.readBits(this.rangeLength);return this.rangeLow+(this.isLowerRange?-t:t)}const t=this.children[e.readBit()];if(!t)throw new Jbig2Error("invalid Huffman data");return t.decodeNode(e)}}class HuffmanTable{constructor(e,t){t||this.assignPrefixCodes(e);this.rootNode=new HuffmanTreeNode(null);for(let t=0,n=e.length;t<n;t++){const n=e[t];n.prefixLength>0&&this.rootNode.buildTree(n,n.prefixLength-1)}}decode(e){return this.rootNode.decodeNode(e)}assignPrefixCodes(e){const t=e.length;let n=0;for(let i=0;i<t;i++)n=Math.max(n,e[i].prefixLength);const i=new Uint32Array(n+1);for(let n=0;n<t;n++)i[e[n].prefixLength]++;let s,r,o,a=1,c=0;i[0]=0;for(;a<=n;){c=c+i[a-1]<<1;s=c;r=0;for(;r<t;){o=e[r];if(o.prefixLength===a){o.prefixCode=s;s++}r++}a++}}}const k={};function getStandardTable(e){let t,n=k[e];if(n)return n;switch(e){case 1:t=[[0,1,4,0],[16,2,8,2],[272,3,16,6],[65808,3,32,7]];break;case 2:t=[[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[75,6,32,62],[6,63]];break;case 3:t=[[-256,8,8,254],[0,1,0,0],[1,2,0,2],[2,3,0,6],[3,4,3,14],[11,5,6,30],[-257,8,32,255,"lower"],[75,7,32,126],[6,62]];break;case 4:t=[[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[76,5,32,31]];break;case 5:t=[[-255,7,8,126],[1,1,0,0],[2,2,0,2],[3,3,0,6],[4,4,3,14],[12,5,6,30],[-256,7,32,127,"lower"],[76,6,32,62]];break;case 6:t=[[-2048,5,10,28],[-1024,4,9,8],[-512,4,8,9],[-256,4,7,10],[-128,5,6,29],[-64,5,5,30],[-32,4,5,11],[0,2,7,0],[128,3,7,2],[256,3,8,3],[512,4,9,12],[1024,4,10,13],[-2049,6,32,62,"lower"],[2048,6,32,63]];break;case 7:t=[[-1024,4,9,8],[-512,3,8,0],[-256,4,7,9],[-128,5,6,26],[-64,5,5,27],[-32,4,5,10],[0,4,5,11],[32,5,5,28],[64,5,6,29],[128,4,7,12],[256,3,8,1],[512,3,9,2],[1024,3,10,3],[-1025,5,32,30,"lower"],[2048,5,32,31]];break;case 8:t=[[-15,8,3,252],[-7,9,1,508],[-5,8,1,253],[-3,9,0,509],[-2,7,0,124],[-1,4,0,10],[0,2,1,0],[2,5,0,26],[3,6,0,58],[4,3,4,4],[20,6,1,59],[22,4,4,11],[38,4,5,12],[70,5,6,27],[134,5,7,28],[262,6,7,60],[390,7,8,125],[646,6,10,61],[-16,9,32,510,"lower"],[1670,9,32,511],[2,1]];break;case 9:t=[[-31,8,4,252],[-15,9,2,508],[-11,8,2,253],[-7,9,1,509],[-5,7,1,124],[-3,4,1,10],[-1,3,1,2],[1,3,1,3],[3,5,1,26],[5,6,1,58],[7,3,5,4],[39,6,2,59],[43,4,5,11],[75,4,6,12],[139,5,7,27],[267,5,8,28],[523,6,8,60],[779,7,9,125],[1291,6,11,61],[-32,9,32,510,"lower"],[3339,9,32,511],[2,0]];break;case 10:t=[[-21,7,4,122],[-5,8,0,252],[-4,7,0,123],[-3,5,0,24],[-2,2,2,0],[2,5,0,25],[3,6,0,54],[4,7,0,124],[5,8,0,253],[6,2,6,1],[70,5,5,26],[102,6,5,55],[134,6,6,56],[198,6,7,57],[326,6,8,58],[582,6,9,59],[1094,6,10,60],[2118,7,11,125],[-22,8,32,254,"lower"],[4166,8,32,255],[2,2]];break;case 11:t=[[1,1,0,0],[2,2,1,2],[4,4,0,12],[5,4,1,13],[7,5,1,28],[9,5,2,29],[13,6,2,60],[17,7,2,122],[21,7,3,123],[29,7,4,124],[45,7,5,125],[77,7,6,126],[141,7,32,127]];break;case 12:t=[[1,1,0,0],[2,2,0,2],[3,3,1,6],[5,5,0,28],[6,5,1,29],[8,6,1,60],[10,7,0,122],[11,7,1,123],[13,7,2,124],[17,7,3,125],[25,7,4,126],[41,8,5,254],[73,8,32,255]];break;case 13:t=[[1,1,0,0],[2,3,0,4],[3,4,0,12],[4,5,0,28],[5,4,1,13],[7,3,3,5],[15,6,1,58],[17,6,2,59],[21,6,3,60],[29,6,4,61],[45,6,5,62],[77,7,6,126],[141,7,32,127]];break;case 14:t=[[-2,3,0,4],[-1,3,0,5],[0,1,0,0],[1,3,0,6],[2,3,0,7]];break;case 15:t=[[-24,7,4,124],[-8,6,2,60],[-4,5,1,28],[-2,4,0,12],[-1,3,0,4],[0,1,0,0],[1,3,0,5],[2,4,0,13],[3,5,1,29],[5,6,2,61],[9,7,4,125],[-25,7,32,126,"lower"],[25,7,32,127]];break;default:throw new Jbig2Error(`standard table B.${e} does not exist`)}for(let e=0,n=t.length;e<n;e++)t[e]=new HuffmanLine(t[e]);n=new HuffmanTable(t,!0);k[e]=n;return n}class Reader{constructor(e,t,n){this.data=e;this.start=t;this.end=n;this.position=t;this.shift=-1;this.currentByte=0}readBit(){if(this.shift<0){if(this.position>=this.end)throw new Jbig2Error("end of data while reading bit");this.currentByte=this.data[this.position++];this.shift=7}const e=this.currentByte>>this.shift&1;this.shift--;return e}readBits(e){let t,n=0;for(t=e-1;t>=0;t--)n|=this.readBit()<<t;return n}byteAlign(){this.shift=-1}next(){return this.position>=this.end?-1:this.data[this.position++]}}function getCustomHuffmanTable(e,t,n){let i=0;for(let s=0,r=t.length;s<r;s++){const r=n[t[s]];if(r){if(e===i)return r;i++}}throw new Jbig2Error("can't find custom Huffman table")}function readUncompressedBitmap(e,t,n){const i=[];for(let s=0;s<n;s++){const n=new Uint8Array(t);i.push(n);for(let i=0;i<t;i++)n[i]=e.readBit();e.byteAlign()}return i}function decodeMMRBitmap(e,t,n,i){const s=new CCITTFaxDecoder(e,{K:-1,Columns:t,Rows:n,BlackIs1:!0,EndOfBlock:i}),r=[];let o,a=!1;for(let e=0;e<n;e++){const e=new Uint8Array(t);r.push(e);let n=-1;for(let i=0;i<t;i++){if(n<0){o=s.readNextChar();if(-1===o){o=0;a=!0}n=7}e[i]=o>>n&1;n--}}if(i&&!a){const e=5;for(let t=0;t<e&&-1!==s.readNextChar();t++);}return r}class Jbig2Image{parseChunks(e){return function parseJbig2Chunks(e){const t=new SimpleSegmentVisitor;for(let n=0,i=e.length;n<i;n++){const i=e[n];processSegments(readSegments({},i.data,i.start,i.end),t)}return t.buffer}(e)}parse(e){const{imgData:t,width:n,height:i}=function parseJbig2(e){const t=e.length;let n=0;if(151!==e[n]||74!==e[n+1]||66!==e[n+2]||50!==e[n+3]||13!==e[n+4]||10!==e[n+5]||26!==e[n+6]||10!==e[n+7])throw new Jbig2Error("parseJbig2 - invalid header.");const i=Object.create(null);n+=8;const s=e[n++];i.randomAccess=!(1&s);if(!(2&s)){i.numberOfPages=readUint32(e,n);n+=4}const r=readSegments(i,e,n,t),o=new SimpleSegmentVisitor;processSegments(r,o);const{width:a,height:c}=o.currentPageInfo,l=o.buffer,h=new Uint8ClampedArray(a*c);let d=0,f=0;for(let e=0;e<c;e++){let e,t=0;for(let n=0;n<a;n++){if(!t){t=128;e=l[f++]}h[d++]=e&t?0:255;t>>=1}}return{imgData:h,width:a,height:c}}(e);this.width=n;this.height=i;return t}}class JpegError extends s{constructor(e){super(`JPEG error: ${e}`,"JpegError")}}class DNLMarkerError extends s{constructor(e,t){super(e,"DNLMarkerError");this.scanLines=t}}class EOIMarkerError extends s{constructor(e){super(e,"EOIMarkerError")}}const C=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),I=4017,B=799,P=3406,T=2276,S=1567,L=3784,v=5793,M=2896;function buildHuffmanTable(e,t){let n,i,s=0,r=16;for(;r>0&&!e[r-1];)r--;const o=[{children:[],index:0}];let a,c=o[0];for(n=0;n<r;n++){for(i=0;i<e[n];i++){c=o.pop();c.children[c.index]=t[s];for(;c.index>0;)c=o.pop();c.index++;o.push(c);for(;o.length<=n;){o.push(a={children:[],index:0});c.children[c.index]=a.children;c=a}s++}if(n+1<r){o.push(a={children:[],index:0});c.children[c.index]=a.children;c=a}}return o[0].children}function getBlockBufferOffset(e,t,n){return 64*((e.blocksPerLine+1)*t+n)}function decodeScan(e,t,n,i,s,r,o,a,c,l=!1){const h=n.mcusPerLine,d=n.progressive,f=t;let u=0,m=0;function readBit(){if(m>0){m--;return u>>m&1}u=e[t++];if(255===u){const i=e[t++];if(i){if(220===i&&l){const i=readUint16(e,t+=2);t+=2;if(i>0&&i!==n.scanLines)throw new DNLMarkerError("Found DNL marker (0xFFDC) while parsing scan data",i)}else if(217===i){if(l){const e=x*(8===n.precision?8:0);if(e>0&&Math.round(n.scanLines/e)>=5)throw new DNLMarkerError("Found EOI marker (0xFFD9) while parsing scan data, possibly caused by incorrect `scanLines` parameter",e)}throw new EOIMarkerError("Found EOI marker (0xFFD9) while parsing scan data")}throw new JpegError(`unexpected marker ${(u<<8|i).toString(16)}`)}}m=7;return u>>>7}function decodeHuffman(e){let t=e;for(;;){t=t[readBit()];switch(typeof t){case"number":return t;case"object":continue}throw new JpegError("invalid huffman sequence")}}function receive(e){let t=0;for(;e>0;){t=t<<1|readBit();e--}return t}function receiveAndExtend(e){if(1===e)return 1===readBit()?1:-1;const t=receive(e);return t>=1<<e-1?t:t+(-1<<e)+1}let g=0;let p,b=0;let x=0;function decodeMcu(e,t,n,i,s){const r=n%h;x=(n/h|0)*e.v+i;const o=r*e.h+s;t(e,getBlockBufferOffset(e,x,o))}function decodeBlock(e,t,n){x=n/e.blocksPerLine|0;const i=n%e.blocksPerLine;t(e,getBlockBufferOffset(e,x,i))}const w=i.length;let y,k,I,B,P,T;T=d?0===r?0===a?function decodeDCFirst(e,t){const n=decodeHuffman(e.huffmanTableDC),i=0===n?0:receiveAndExtend(n)<<c;e.blockData[t]=e.pred+=i}:function decodeDCSuccessive(e,t){e.blockData[t]|=readBit()<<c}:0===a?function decodeACFirst(e,t){if(g>0){g--;return}let n=r;const i=o;for(;n<=i;){const i=decodeHuffman(e.huffmanTableAC),s=15&i,r=i>>4;if(0===s){if(r<15){g=receive(r)+(1<<r)-1;break}n+=16;continue}n+=r;const o=C[n];e.blockData[t+o]=receiveAndExtend(s)*(1<<c);n++}}:function decodeACSuccessive(e,t){let n=r;const i=o;let s,a,l=0;for(;n<=i;){const i=t+C[n],r=e.blockData[i]<0?-1:1;switch(b){case 0:a=decodeHuffman(e.huffmanTableAC);s=15&a;l=a>>4;if(0===s)if(l<15){g=receive(l)+(1<<l);b=4}else{l=16;b=1}else{if(1!==s)throw new JpegError("invalid ACn encoding");p=receiveAndExtend(s);b=l?2:3}continue;case 1:case 2:if(e.blockData[i])e.blockData[i]+=r*(readBit()<<c);else{l--;0===l&&(b=2===b?3:0)}break;case 3:if(e.blockData[i])e.blockData[i]+=r*(readBit()<<c);else{e.blockData[i]=p<<c;b=0}break;case 4:e.blockData[i]&&(e.blockData[i]+=r*(readBit()<<c))}n++}if(4===b){g--;0===g&&(b=0)}}:function decodeBaseline(e,t){const n=decodeHuffman(e.huffmanTableDC),i=0===n?0:receiveAndExtend(n);e.blockData[t]=e.pred+=i;let s=1;for(;s<64;){const n=decodeHuffman(e.huffmanTableAC),i=15&n,r=n>>4;if(0===i){if(r<15)break;s+=16;continue}s+=r;const o=C[s];e.blockData[t+o]=receiveAndExtend(i);s++}};let S,L=0;const v=1===w?i[0].blocksPerLine*i[0].blocksPerColumn:h*n.mcusPerColumn;let M,_;for(;L<=v;){const n=s?Math.min(v-L,s):v;if(n>0){for(k=0;k<w;k++)i[k].pred=0;g=0;if(1===w){y=i[0];for(P=0;P<n;P++){decodeBlock(y,T,L);L++}}else for(P=0;P<n;P++){for(k=0;k<w;k++){y=i[k];M=y.h;_=y.v;for(I=0;I<_;I++)for(B=0;B<M;B++)decodeMcu(y,T,L,I,B)}L++}}m=0;S=findNextFileMarker(e,t);if(!S)break;if(S.invalid){util_warn(`decodeScan - ${n>0?"unexpected":"excessive"} MCU data, current marker is: ${S.invalid}`);t=S.offset}if(!(S.marker>=65488&&S.marker<=65495))break;t+=2}return t-f}function quantizeAndInverse(e,t,n){const i=e.quantizationTable,s=e.blockData;let r,o,a,c,l,h,d,f,u,m,g,p,b,x,w,y,k;if(!i)throw new JpegError("missing required Quantization Table.");for(let e=0;e<64;e+=8){u=s[t+e];m=s[t+e+1];g=s[t+e+2];p=s[t+e+3];b=s[t+e+4];x=s[t+e+5];w=s[t+e+6];y=s[t+e+7];u*=i[e];if(0!=(m|g|p|b|x|w|y)){m*=i[e+1];g*=i[e+2];p*=i[e+3];b*=i[e+4];x*=i[e+5];w*=i[e+6];y*=i[e+7];r=v*u+128>>8;o=v*b+128>>8;a=g;c=w;l=M*(m-y)+128>>8;f=M*(m+y)+128>>8;h=p<<4;d=x<<4;r=r+o+1>>1;o=r-o;k=a*L+c*S+128>>8;a=a*S-c*L+128>>8;c=k;l=l+d+1>>1;d=l-d;f=f+h+1>>1;h=f-h;r=r+c+1>>1;c=r-c;o=o+a+1>>1;a=o-a;k=l*T+f*P+2048>>12;l=l*P-f*T+2048>>12;f=k;k=h*B+d*I+2048>>12;h=h*I-d*B+2048>>12;d=k;n[e]=r+f;n[e+7]=r-f;n[e+1]=o+d;n[e+6]=o-d;n[e+2]=a+h;n[e+5]=a-h;n[e+3]=c+l;n[e+4]=c-l}else{k=v*u+512>>10;n[e]=k;n[e+1]=k;n[e+2]=k;n[e+3]=k;n[e+4]=k;n[e+5]=k;n[e+6]=k;n[e+7]=k}}for(let e=0;e<8;++e){u=n[e];m=n[e+8];g=n[e+16];p=n[e+24];b=n[e+32];x=n[e+40];w=n[e+48];y=n[e+56];if(0!=(m|g|p|b|x|w|y)){r=v*u+2048>>12;o=v*b+2048>>12;a=g;c=w;l=M*(m-y)+2048>>12;f=M*(m+y)+2048>>12;h=p;d=x;r=4112+(r+o+1>>1);o=r-o;k=a*L+c*S+2048>>12;a=a*S-c*L+2048>>12;c=k;l=l+d+1>>1;d=l-d;f=f+h+1>>1;h=f-h;r=r+c+1>>1;c=r-c;o=o+a+1>>1;a=o-a;k=l*T+f*P+2048>>12;l=l*P-f*T+2048>>12;f=k;k=h*B+d*I+2048>>12;h=h*I-d*B+2048>>12;d=k;u=r+f;y=r-f;m=o+d;w=o-d;g=a+h;x=a-h;p=c+l;b=c-l;u<16?u=0:u>=4080?u=255:u>>=4;m<16?m=0:m>=4080?m=255:m>>=4;g<16?g=0:g>=4080?g=255:g>>=4;p<16?p=0:p>=4080?p=255:p>>=4;b<16?b=0:b>=4080?b=255:b>>=4;x<16?x=0:x>=4080?x=255:x>>=4;w<16?w=0:w>=4080?w=255:w>>=4;y<16?y=0:y>=4080?y=255:y>>=4;s[t+e]=u;s[t+e+8]=m;s[t+e+16]=g;s[t+e+24]=p;s[t+e+32]=b;s[t+e+40]=x;s[t+e+48]=w;s[t+e+56]=y}else{k=v*u+8192>>14;k=k<-2040?0:k>=2024?255:k+2056>>4;s[t+e]=k;s[t+e+8]=k;s[t+e+16]=k;s[t+e+24]=k;s[t+e+32]=k;s[t+e+40]=k;s[t+e+48]=k;s[t+e+56]=k}}}function buildComponentData(e,t){const n=t.blocksPerLine,i=t.blocksPerColumn,s=new Int16Array(64);for(let e=0;e<i;e++)for(let i=0;i<n;i++){quantizeAndInverse(t,getBlockBufferOffset(t,e,i),s)}return t.blockData}function findNextFileMarker(e,t,n=t){const i=e.length-1;let s=n<t?n:t;if(t>=i)return null;const r=readUint16(e,t);if(r>=65472&&r<=65534)return{invalid:null,marker:r,offset:t};let o=readUint16(e,s);for(;!(o>=65472&&o<=65534);){if(++s>=i)return null;o=readUint16(e,s)}return{invalid:r.toString(16),marker:o,offset:s}}class JpegImage{constructor({decodeTransform:e=null,colorTransform:t=-1}={}){this._decodeTransform=e;this._colorTransform=t}parse(e,{dnlScanLines:t=null}={}){function readDataBlock(){const t=readUint16(e,s);s+=2;let n=s+t-2;const i=findNextFileMarker(e,n,s);if(i?.invalid){util_warn("readDataBlock - incorrect length, current marker is: "+i.invalid);n=i.offset}const r=e.subarray(s,n);s+=r.length;return r}function prepareComponents(e){const t=Math.ceil(e.samplesPerLine/8/e.maxH),n=Math.ceil(e.scanLines/8/e.maxV);for(const i of e.components){const s=Math.ceil(Math.ceil(e.samplesPerLine/8)*i.h/e.maxH),r=Math.ceil(Math.ceil(e.scanLines/8)*i.v/e.maxV),o=t*i.h,a=64*(n*i.v)*(o+1);i.blockData=new Int16Array(a);i.blocksPerLine=s;i.blocksPerColumn=r}e.mcusPerLine=t;e.mcusPerColumn=n}let n,i,s=0,r=null,o=null,a=0;const c=[],l=[],h=[];let d=readUint16(e,s);s+=2;if(65496!==d)throw new JpegError("SOI not found");d=readUint16(e,s);s+=2;e:for(;65497!==d;){let f,u,m;switch(d){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:const g=readDataBlock();65504===d&&74===g[0]&&70===g[1]&&73===g[2]&&70===g[3]&&0===g[4]&&(r={version:{major:g[5],minor:g[6]},densityUnits:g[7],xDensity:g[8]<<8|g[9],yDensity:g[10]<<8|g[11],thumbWidth:g[12],thumbHeight:g[13],thumbData:g.subarray(14,14+3*g[12]*g[13])});65518===d&&65===g[0]&&100===g[1]&&111===g[2]&&98===g[3]&&101===g[4]&&(o={version:g[5]<<8|g[6],flags0:g[7]<<8|g[8],flags1:g[9]<<8|g[10],transformCode:g[11]});break;case 65499:const p=readUint16(e,s);s+=2;const b=p+s-2;let x;for(;s<b;){const t=e[s++],n=new Uint16Array(64);if(t>>4==0)for(u=0;u<64;u++){x=C[u];n[x]=e[s++]}else{if(t>>4!=1)throw new JpegError("DQT - invalid table spec");for(u=0;u<64;u++){x=C[u];n[x]=readUint16(e,s);s+=2}}c[15&t]=n}break;case 65472:case 65473:case 65474:if(n)throw new JpegError("Only single frame JPEGs supported");s+=2;n={};n.extended=65473===d;n.progressive=65474===d;n.precision=e[s++];const w=readUint16(e,s);s+=2;n.scanLines=t||w;n.samplesPerLine=readUint16(e,s);s+=2;n.components=[];n.componentIds={};const y=e[s++];let k=0,I=0;for(f=0;f<y;f++){const t=e[s],i=e[s+1]>>4,r=15&e[s+1];k<i&&(k=i);I<r&&(I=r);const o=e[s+2];m=n.components.push({h:i,v:r,quantizationId:o,quantizationTable:null});n.componentIds[t]=m-1;s+=3}n.maxH=k;n.maxV=I;prepareComponents(n);break;case 65476:const B=readUint16(e,s);s+=2;for(f=2;f<B;){const t=e[s++],n=new Uint8Array(16);let i=0;for(u=0;u<16;u++,s++)i+=n[u]=e[s];const r=new Uint8Array(i);for(u=0;u<i;u++,s++)r[u]=e[s];f+=17+i;(t>>4==0?h:l)[15&t]=buildHuffmanTable(n,r)}break;case 65501:s+=2;i=readUint16(e,s);s+=2;break;case 65498:const P=1==++a&&!t;s+=2;const T=e[s++],S=[];for(f=0;f<T;f++){const t=e[s++],i=n.componentIds[t],r=n.components[i];r.index=t;const o=e[s++];r.huffmanTableDC=h[o>>4];r.huffmanTableAC=l[15&o];S.push(r)}const L=e[s++],v=e[s++],M=e[s++];try{const t=decodeScan(e,s,n,S,i,L,v,M>>4,15&M,P);s+=t}catch(t){if(t instanceof DNLMarkerError){util_warn(`${t.message} -- attempting to re-parse the JPEG image.`);return this.parse(e,{dnlScanLines:t.scanLines})}if(t instanceof EOIMarkerError){util_warn(`${t.message} -- ignoring the rest of the image data.`);break e}throw t}break;case 65500:s+=4;break;case 65535:255!==e[s]&&s--;break;default:const _=findNextFileMarker(e,s-2,s-3);if(_?.invalid){util_warn("JpegImage.parse - unexpected data, current marker is: "+_.invalid);s=_.offset;break}if(!_||s>=e.length-1){util_warn("JpegImage.parse - reached the end of the image data without finding an EOI marker (0xFFD9).");break e}throw new JpegError("JpegImage.parse - unknown marker: "+d.toString(16))}d=readUint16(e,s);s+=2}this.width=n.samplesPerLine;this.height=n.scanLines;this.jfif=r;this.adobe=o;this.components=[];for(const e of n.components){const t=c[e.quantizationId];t&&(e.quantizationTable=t);this.components.push({index:e.index,output:buildComponentData(0,e),scaleX:e.h/n.maxH,scaleY:e.v/n.maxV,blocksPerLine:e.blocksPerLine,blocksPerColumn:e.blocksPerColumn})}this.numComponents=this.components.length}_getLinearizedBlockData(e,t,n=!1){const i=this.width/e,s=this.height/t;let r,o,a,c,l,h,d,f,u,m,g,p=0;const b=this.components.length,x=e*t*b,w=new Uint8ClampedArray(x),y=new Uint32Array(e),k=4294967288;let C;for(d=0;d<b;d++){r=this.components[d];o=r.scaleX*i;a=r.scaleY*s;p=d;g=r.output;c=r.blocksPerLine+1<<3;if(o!==C){for(l=0;l<e;l++){f=0|l*o;y[l]=(f&k)<<3|7&f}C=o}for(h=0;h<t;h++){f=0|h*a;m=c*(f&k)|(7&f)<<3;for(l=0;l<e;l++){w[p]=g[m+y[l]];p+=b}}}let I=this._decodeTransform;n||4!==b||I||(I=new Int32Array([-256,255,-256,255,-256,255,-256,255]));if(I)for(d=0;d<x;)for(f=0,u=0;f<b;f++,d++,u+=2)w[d]=(w[d]*I[u]>>8)+I[u+1];return w}get _isColorConversionNeeded(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this._colorTransform&&(82!==this.components[0].index||71!==this.components[1].index||66!==this.components[2].index):1===this._colorTransform}_convertYccToRgb(e){let t,n,i;for(let s=0,r=e.length;s<r;s+=3){t=e[s];n=e[s+1];i=e[s+2];e[s]=t-179.456+1.402*i;e[s+1]=t+135.459-.344*n-.714*i;e[s+2]=t-226.816+1.772*n}return e}_convertYccToRgba(e,t){for(let n=0,i=0,s=e.length;n<s;n+=3,i+=4){const s=e[n],r=e[n+1],o=e[n+2];t[i]=s-179.456+1.402*o;t[i+1]=s+135.459-.344*r-.714*o;t[i+2]=s-226.816+1.772*r;t[i+3]=255}return t}_convertYcckToRgb(e){let t,n,i,s,r=0;for(let o=0,a=e.length;o<a;o+=4){t=e[o];n=e[o+1];i=e[o+2];s=e[o+3];e[r++]=n*(-660635669420364e-19*n+.000437130475926232*i-54080610064599e-18*t+.00048449797120281*s-.154362151871126)-122.67195406894+i*(-.000957964378445773*i+.000817076911346625*t-.00477271405408747*s+1.53380253221734)+t*(.000961250184130688*t-.00266257332283933*s+.48357088451265)+s*(-.000336197177618394*s+.484791561490776);e[r++]=107.268039397724+n*(219927104525741e-19*n-.000640992018297945*i+.000659397001245577*t+.000426105652938837*s-.176491792462875)+i*(-.000778269941513683*i+.00130872261408275*t+.000770482631801132*s-.151051492775562)+t*(.00126935368114843*t-.00265090189010898*s+.25802910206845)+s*(-.000318913117588328*s-.213742400323665);e[r++]=n*(-.000570115196973677*n-263409051004589e-19*i+.0020741088115012*t-.00288260236853442*s+.814272968359295)-20.810012546947+i*(-153496057440975e-19*i-.000132689043961446*t+.000560833691242812*s-.195152027534049)+t*(.00174418132927582*t-.00255243321439347*s+.116935020465145)+s*(-.000343531996510555*s+.24165260232407)}return e.subarray(0,r)}_convertYcckToRgba(e){for(let t=0,n=e.length;t<n;t+=4){const n=e[t],i=e[t+1],s=e[t+2],r=e[t+3];e[t]=i*(-660635669420364e-19*i+.000437130475926232*s-54080610064599e-18*n+.00048449797120281*r-.154362151871126)-122.67195406894+s*(-.000957964378445773*s+.000817076911346625*n-.00477271405408747*r+1.53380253221734)+n*(.000961250184130688*n-.00266257332283933*r+.48357088451265)+r*(-.000336197177618394*r+.484791561490776);e[t+1]=107.268039397724+i*(219927104525741e-19*i-.000640992018297945*s+.000659397001245577*n+.000426105652938837*r-.176491792462875)+s*(-.000778269941513683*s+.00130872261408275*n+.000770482631801132*r-.151051492775562)+n*(.00126935368114843*n-.00265090189010898*r+.25802910206845)+r*(-.000318913117588328*r-.213742400323665);e[t+2]=i*(-.000570115196973677*i-263409051004589e-19*s+.0020741088115012*n-.00288260236853442*r+.814272968359295)-20.810012546947+s*(-153496057440975e-19*s-.000132689043961446*n+.000560833691242812*r-.195152027534049)+n*(.00174418132927582*n-.00255243321439347*r+.116935020465145)+r*(-.000343531996510555*r+.24165260232407);e[t+3]=255}return e}_convertYcckToCmyk(e){let t,n,i;for(let s=0,r=e.length;s<r;s+=4){t=e[s];n=e[s+1];i=e[s+2];e[s]=434.456-t-1.402*i;e[s+1]=119.541-t+.344*n+.714*i;e[s+2]=481.816-t-1.772*n}return e}_convertCmykToRgb(e){let t,n,i,s,r=0;for(let o=0,a=e.length;o<a;o+=4){t=e[o];n=e[o+1];i=e[o+2];s=e[o+3];e[r++]=255+t*(-6747147073602441e-20*t+.0008379262121013727*n+.0002894718188643294*i+.003264231057537806*s-1.1185611867203937)+n*(26374107616089405e-21*n-8626949158638572e-20*i-.0002748769067499491*s-.02155688794978967)+i*(-3878099212869363e-20*i-.0003267808279485286*s+.0686742238595345)-s*(.0003361971776183937*s+.7430659151342254);e[r++]=255+t*(.00013596372813588848*t+.000924537132573585*n+.00010567359618683593*i+.0004791864687436512*s-.3109689587515875)+n*(-.00023545346108370344*n+.0002702845253534714*i+.0020200308977307156*s-.7488052167015494)+i*(6834815998235662e-20*i+.00015168452363460973*s-.09751927774728933)-s*(.0003189131175883281*s+.7364883807733168);e[r++]=255+t*(13598650411385307e-21*t+.00012423956175490851*n+.0004751985097583589*i-36729317476630422e-22*s-.05562186980264034)+n*(.00016141380598724676*n+.0009692239130725186*i+.0007782692450036253*s-.44015232367526463)+i*(5.068882914068769e-7*i+.0017778369011375071*s-.7591454649749609)-s*(.0003435319965105553*s+.7063770186160144)}return e.subarray(0,r)}_convertCmykToRgba(e){for(let t=0,n=e.length;t<n;t+=4){const n=e[t],i=e[t+1],s=e[t+2],r=e[t+3];e[t]=255+n*(-6747147073602441e-20*n+.0008379262121013727*i+.0002894718188643294*s+.003264231057537806*r-1.1185611867203937)+i*(26374107616089405e-21*i-8626949158638572e-20*s-.0002748769067499491*r-.02155688794978967)+s*(-3878099212869363e-20*s-.0003267808279485286*r+.0686742238595345)-r*(.0003361971776183937*r+.7430659151342254);e[t+1]=255+n*(.00013596372813588848*n+.000924537132573585*i+.00010567359618683593*s+.0004791864687436512*r-.3109689587515875)+i*(-.00023545346108370344*i+.0002702845253534714*s+.0020200308977307156*r-.7488052167015494)+s*(6834815998235662e-20*s+.00015168452363460973*r-.09751927774728933)-r*(.0003189131175883281*r+.7364883807733168);e[t+2]=255+n*(13598650411385307e-21*n+.00012423956175490851*i+.0004751985097583589*s-36729317476630422e-22*r-.05562186980264034)+i*(.00016141380598724676*i+.0009692239130725186*s+.0007782692450036253*r-.44015232367526463)+s*(5.068882914068769e-7*s+.0017778369011375071*r-.7591454649749609)-r*(.0003435319965105553*r+.7063770186160144);e[t+3]=255}return e}getData({width:e,height:t,forceRGBA:n=!1,forceRGB:i=!1,isSourcePDF:s=!1}){if(this.numComponents>4)throw new JpegError("Unsupported color mode");const r=this._getLinearizedBlockData(e,t,s);if(1===this.numComponents&&(n||i)){const e=r.length*(n?4:3),t=new Uint8ClampedArray(e);let i=0;if(n)!function grayToRGBA(e,t){if(util_FeatureTest.isLittleEndian)for(let n=0,i=e.length;n<i;n++)t[n]=65793*e[n]|4278190080;else for(let n=0,i=e.length;n<i;n++)t[n]=16843008*e[n]|255}(r,new Uint32Array(t.buffer));else for(const e of r){t[i++]=e;t[i++]=e;t[i++]=e}return t}if(3===this.numComponents&&this._isColorConversionNeeded){if(n){const e=new Uint8ClampedArray(r.length/3*4);return this._convertYccToRgba(r,e)}return this._convertYccToRgb(r)}if(4===this.numComponents){if(this._isColorConversionNeeded)return n?this._convertYcckToRgba(r):i?this._convertYcckToRgb(r):this._convertYcckToCmyk(r);if(n)return this._convertCmykToRgba(r);if(i)return this._convertCmykToRgb(r)}return r}}class JpxError extends s{constructor(e){super(`JPX error: ${e}`,"JpxError")}}const _={LL:0,LH:1,HL:1,HH:2};class JpxImage{constructor(){this.failOnCorruptedImage=!1}parse(e){if(65359===readUint16(e,0)){this.parseCodestream(e,0,e.length);return}const t=e.length;let n=0;for(;n<t;){let i=8,s=readUint32(e,n);const r=readUint32(e,n+4);n+=i;if(1===s){s=4294967296*readUint32(e,n)+readUint32(e,n+4);n+=8;i+=8}0===s&&(s=t-n+i);if(s<i)throw new JpxError("Invalid box field size");const o=s-i;let a=!0;switch(r){case 1785737832:a=!1;break;case 1668246642:const t=e[n];if(1===t){const t=readUint32(e,n+3);switch(t){case 16:case 17:case 18:break;default:util_warn("Unknown colorspace "+t)}}else 2===t&&info("ICC profile not supported");break;case 1785737827:this.parseCodestream(e,n,n+o);break;case 1783636e3:218793738!==readUint32(e,n)&&util_warn("Invalid JP2 signature");break;case 1783634458:case 1718909296:case 1920099697:case 1919251232:case 1768449138:break;default:util_warn(`Unsupported header type ${r} (${String.fromCharCode(r>>24&255,r>>16&255,r>>8&255,255&r)}).`)}a&&(n+=o)}}parseImageProperties(e){let t=e.getByte();for(;t>=0;){const n=t;t=e.getByte();if(65361===(n<<8|t)){e.skip(4);const t=e.getInt32()>>>0,n=e.getInt32()>>>0,i=e.getInt32()>>>0,s=e.getInt32()>>>0;e.skip(16);const r=e.getUint16();this.width=t-i;this.height=n-s;this.componentsCount=r;this.bitsPerComponent=8;return}}throw new JpxError("No size marker found in JPX stream")}parseCodestream(e,t,n){const i={};let s=!1;try{let r=t;for(;r+1<n;){const t=readUint16(e,r);r+=2;let n,o,a,c,l,h,d=0;switch(t){case 65359:i.mainHeader=!0;break;case 65497:break;case 65361:d=readUint16(e,r);const f={};f.Xsiz=readUint32(e,r+4);f.Ysiz=readUint32(e,r+8);f.XOsiz=readUint32(e,r+12);f.YOsiz=readUint32(e,r+16);f.XTsiz=readUint32(e,r+20);f.YTsiz=readUint32(e,r+24);f.XTOsiz=readUint32(e,r+28);f.YTOsiz=readUint32(e,r+32);const u=readUint16(e,r+36);f.Csiz=u;const m=[];n=r+38;for(let t=0;t<u;t++){const t={precision:1+(127&e[n]),isSigned:!!(128&e[n]),XRsiz:e[n+1],YRsiz:e[n+2]};n+=3;calculateComponentDimensions(t,f);m.push(t)}i.SIZ=f;i.components=m;calculateTileGrids(i,m);i.QCC=[];i.COC=[];break;case 65372:d=readUint16(e,r);const g={};n=r+2;o=e[n++];switch(31&o){case 0:c=8;l=!0;break;case 1:c=16;l=!1;break;case 2:c=16;l=!0;break;default:throw new Error("Invalid SQcd value "+o)}g.noQuantization=8===c;g.scalarExpounded=l;g.guardBits=o>>5;a=[];for(;n<d+r;){const t={};if(8===c){t.epsilon=e[n++]>>3;t.mu=0}else{t.epsilon=e[n]>>3;t.mu=(7&e[n])<<8|e[n+1];n+=2}a.push(t)}g.SPqcds=a;if(i.mainHeader)i.QCD=g;else{i.currentTile.QCD=g;i.currentTile.QCC=[]}break;case 65373:d=readUint16(e,r);const p={};n=r+2;let b;if(i.SIZ.Csiz<257)b=e[n++];else{b=readUint16(e,n);n+=2}o=e[n++];switch(31&o){case 0:c=8;l=!0;break;case 1:c=16;l=!1;break;case 2:c=16;l=!0;break;default:throw new Error("Invalid SQcd value "+o)}p.noQuantization=8===c;p.scalarExpounded=l;p.guardBits=o>>5;a=[];for(;n<d+r;){const t={};if(8===c){t.epsilon=e[n++]>>3;t.mu=0}else{t.epsilon=e[n]>>3;t.mu=(7&e[n])<<8|e[n+1];n+=2}a.push(t)}p.SPqcds=a;i.mainHeader?i.QCC[b]=p:i.currentTile.QCC[b]=p;break;case 65362:d=readUint16(e,r);const x={};n=r+2;const w=e[n++];x.entropyCoderWithCustomPrecincts=!!(1&w);x.sopMarkerUsed=!!(2&w);x.ephMarkerUsed=!!(4&w);x.progressionOrder=e[n++];x.layersCount=readUint16(e,n);n+=2;x.multipleComponentTransform=e[n++];x.decompositionLevelsCount=e[n++];x.xcb=2+(15&e[n++]);x.ycb=2+(15&e[n++]);const y=e[n++];x.selectiveArithmeticCodingBypass=!!(1&y);x.resetContextProbabilities=!!(2&y);x.terminationOnEachCodingPass=!!(4&y);x.verticallyStripe=!!(8&y);x.predictableTermination=!!(16&y);x.segmentationSymbolUsed=!!(32&y);x.reversibleTransformation=e[n++];if(x.entropyCoderWithCustomPrecincts){const t=[];for(;n<d+r;){const i=e[n++];t.push({PPx:15&i,PPy:i>>4})}x.precinctsSizes=t}const k=[];x.selectiveArithmeticCodingBypass&&k.push("selectiveArithmeticCodingBypass");x.terminationOnEachCodingPass&&k.push("terminationOnEachCodingPass");x.verticallyStripe&&k.push("verticallyStripe");x.predictableTermination&&k.push("predictableTermination");if(k.length>0){s=!0;util_warn(`JPX: Unsupported COD options (${k.join(", ")}).`)}if(i.mainHeader)i.COD=x;else{i.currentTile.COD=x;i.currentTile.COC=[]}break;case 65424:d=readUint16(e,r);h={};h.index=readUint16(e,r+2);h.length=readUint32(e,r+4);h.dataEnd=h.length+r-2;h.partIndex=e[r+8];h.partsCount=e[r+9];i.mainHeader=!1;if(0===h.partIndex){h.COD=i.COD;h.COC=i.COC.slice(0);h.QCD=i.QCD;h.QCC=i.QCC.slice(0)}i.currentTile=h;break;case 65427:h=i.currentTile;if(0===h.partIndex){initializeTile(i,h.index);buildPackets(i)}d=h.dataEnd-r;parseTilePackets(i,e,r,d);break;case 65363:util_warn("JPX: Codestream code 0xFF53 (COC) is not implemented.");case 65365:case 65367:case 65368:case 65380:d=readUint16(e,r);break;default:throw new Error("Unknown codestream code: "+t.toString(16))}r+=d}}catch(e){if(s||this.failOnCorruptedImage)throw new JpxError(e.message);util_warn(`JPX: Trying to recover from: "${e.message}".`)}this.tiles=function transformComponents(e){const t=e.SIZ,n=e.components,i=t.Csiz,s=[];for(let t=0,r=e.tiles.length;t<r;t++){const r=e.tiles[t],o=[];for(let t=0;t<i;t++)o[t]=transformTile(e,r,t);const a=o[0],c=new Uint8ClampedArray(a.items.length*i),l={left:a.left,top:a.top,width:a.width,height:a.height,items:c};let h,d,f,u,m,g,p,b=0;if(r.codingStyleDefaultParameters.multipleComponentTransform){const e=4===i,t=o[0].items,s=o[1].items,a=o[2].items,l=e?o[3].items:null;h=n[0].precision-8;d=.5+(128<<h);const x=r.components[0],w=i-3;u=t.length;if(x.codingStyleParameters.reversibleTransformation)for(f=0;f<u;f++,b+=w){m=t[f]+d;g=s[f];p=a[f];const e=m-(p+g>>2);c[b++]=e+p>>h;c[b++]=e>>h;c[b++]=e+g>>h}else for(f=0;f<u;f++,b+=w){m=t[f]+d;g=s[f];p=a[f];c[b++]=m+1.402*p>>h;c[b++]=m-.34413*g-.71414*p>>h;c[b++]=m+1.772*g>>h}if(e)for(f=0,b=3;f<u;f++,b+=4)c[b]=l[f]+d>>h}else for(let e=0;e<i;e++){const t=o[e].items;h=n[e].precision-8;d=.5+(128<<h);for(b=e,f=0,u=t.length;f<u;f++){c[b]=t[f]+d>>h;b+=i}}s.push(l)}return s}(i);this.width=i.SIZ.Xsiz-i.SIZ.XOsiz;this.height=i.SIZ.Ysiz-i.SIZ.YOsiz;this.componentsCount=i.SIZ.Csiz}}function calculateComponentDimensions(e,t){e.x0=Math.ceil(t.XOsiz/e.XRsiz);e.x1=Math.ceil(t.Xsiz/e.XRsiz);e.y0=Math.ceil(t.YOsiz/e.YRsiz);e.y1=Math.ceil(t.Ysiz/e.YRsiz);e.width=e.x1-e.x0;e.height=e.y1-e.y0}function calculateTileGrids(e,t){const n=e.SIZ,i=[];let s;const r=Math.ceil((n.Xsiz-n.XTOsiz)/n.XTsiz),o=Math.ceil((n.Ysiz-n.YTOsiz)/n.YTsiz);for(let e=0;e<o;e++)for(let t=0;t<r;t++){s={};s.tx0=Math.max(n.XTOsiz+t*n.XTsiz,n.XOsiz);s.ty0=Math.max(n.YTOsiz+e*n.YTsiz,n.YOsiz);s.tx1=Math.min(n.XTOsiz+(t+1)*n.XTsiz,n.Xsiz);s.ty1=Math.min(n.YTOsiz+(e+1)*n.YTsiz,n.Ysiz);s.width=s.tx1-s.tx0;s.height=s.ty1-s.ty0;s.components=[];i.push(s)}e.tiles=i;for(let e=0,r=n.Csiz;e<r;e++){const n=t[e];for(let t=0,r=i.length;t<r;t++){const r={};s=i[t];r.tcx0=Math.ceil(s.tx0/n.XRsiz);r.tcy0=Math.ceil(s.ty0/n.YRsiz);r.tcx1=Math.ceil(s.tx1/n.XRsiz);r.tcy1=Math.ceil(s.ty1/n.YRsiz);r.width=r.tcx1-r.tcx0;r.height=r.tcy1-r.tcy0;s.components[e]=r}}}function getBlocksDimensions(e,t,n){const i=t.codingStyleParameters,s={};if(i.entropyCoderWithCustomPrecincts){s.PPx=i.precinctsSizes[n].PPx;s.PPy=i.precinctsSizes[n].PPy}else{s.PPx=15;s.PPy=15}s.xcb_=n>0?Math.min(i.xcb,s.PPx-1):Math.min(i.xcb,s.PPx);s.ycb_=n>0?Math.min(i.ycb,s.PPy-1):Math.min(i.ycb,s.PPy);return s}function buildPrecincts(e,t,n){const i=1<<n.PPx,s=1<<n.PPy,r=0===t.resLevel,o=1<<n.PPx+(r?0:-1),a=1<<n.PPy+(r?0:-1),c=t.trx1>t.trx0?Math.ceil(t.trx1/i)-Math.floor(t.trx0/i):0,l=t.try1>t.try0?Math.ceil(t.try1/s)-Math.floor(t.try0/s):0,h=c*l;t.precinctParameters={precinctWidth:i,precinctHeight:s,numprecinctswide:c,numprecinctshigh:l,numprecincts:h,precinctWidthInSubband:o,precinctHeightInSubband:a}}function buildCodeblocks(e,t,n){const i=n.xcb_,s=n.ycb_,r=1<<i,o=1<<s,a=t.tbx0>>i,c=t.tby0>>s,l=t.tbx1+r-1>>i,h=t.tby1+o-1>>s,d=t.resolution.precinctParameters,f=[],u=[];let m,g,p,b;for(g=c;g<h;g++)for(m=a;m<l;m++){p={cbx:m,cby:g,tbx0:r*m,tby0:o*g,tbx1:r*(m+1),tby1:o*(g+1)};p.tbx0_=Math.max(t.tbx0,p.tbx0);p.tby0_=Math.max(t.tby0,p.tby0);p.tbx1_=Math.min(t.tbx1,p.tbx1);p.tby1_=Math.min(t.tby1,p.tby1);b=Math.floor((p.tbx0_-t.tbx0)/d.precinctWidthInSubband)+Math.floor((p.tby0_-t.tby0)/d.precinctHeightInSubband)*d.numprecinctswide;p.precinctNumber=b;p.subbandType=t.type;p.Lblock=3;if(p.tbx1_<=p.tbx0_||p.tby1_<=p.tby0_)continue;f.push(p);let e=u[b];if(void 0!==e){m<e.cbxMin?e.cbxMin=m:m>e.cbxMax&&(e.cbxMax=m);g<e.cbyMin?e.cbxMin=g:g>e.cbyMax&&(e.cbyMax=g)}else u[b]=e={cbxMin:m,cbyMin:g,cbxMax:m,cbyMax:g};p.precinct=e}t.codeblockParameters={codeblockWidth:i,codeblockHeight:s,numcodeblockwide:l-a+1,numcodeblockhigh:h-c+1};t.codeblocks=f;t.precincts=u}function createPacket(e,t,n){const i=[],s=e.subbands;for(let e=0,n=s.length;e<n;e++){const n=s[e].codeblocks;for(let e=0,s=n.length;e<s;e++){const s=n[e];s.precinctNumber===t&&i.push(s)}}return{layerNumber:n,codeblocks:i}}function LayerResolutionComponentPositionIterator(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=i.codingStyleDefaultParameters.layersCount,r=t.Csiz;let o=0;for(let e=0;e<r;e++)o=Math.max(o,i.components[e].codingStyleParameters.decompositionLevelsCount);let a=0,c=0,l=0,h=0;this.nextPacket=function JpxImage_nextPacket(){for(;a<s;a++){for(;c<=o;c++){for(;l<r;l++){const e=i.components[l];if(c>e.codingStyleParameters.decompositionLevelsCount)continue;const t=e.resolutions[c],n=t.precinctParameters.numprecincts;for(;h<n;){const e=createPacket(t,h,a);h++;return e}h=0}l=0}c=0}throw new JpxError("Out of packets")}}function ResolutionLayerComponentPositionIterator(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=i.codingStyleDefaultParameters.layersCount,r=t.Csiz;let o=0;for(let e=0;e<r;e++)o=Math.max(o,i.components[e].codingStyleParameters.decompositionLevelsCount);let a=0,c=0,l=0,h=0;this.nextPacket=function JpxImage_nextPacket(){for(;a<=o;a++){for(;c<s;c++){for(;l<r;l++){const e=i.components[l];if(a>e.codingStyleParameters.decompositionLevelsCount)continue;const t=e.resolutions[a],n=t.precinctParameters.numprecincts;for(;h<n;){const e=createPacket(t,h,c);h++;return e}h=0}l=0}c=0}throw new JpxError("Out of packets")}}function ResolutionPositionComponentLayerIterator(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=i.codingStyleDefaultParameters.layersCount,r=t.Csiz;let o,a,c,l,h=0;for(c=0;c<r;c++){const e=i.components[c];h=Math.max(h,e.codingStyleParameters.decompositionLevelsCount)}const d=new Int32Array(h+1);for(a=0;a<=h;++a){let e=0;for(c=0;c<r;++c){const t=i.components[c].resolutions;a<t.length&&(e=Math.max(e,t[a].precinctParameters.numprecincts))}d[a]=e}o=0;a=0;c=0;l=0;this.nextPacket=function JpxImage_nextPacket(){for(;a<=h;a++){for(;l<d[a];l++){for(;c<r;c++){const e=i.components[c];if(a>e.codingStyleParameters.decompositionLevelsCount)continue;const t=e.resolutions[a],n=t.precinctParameters.numprecincts;if(!(l>=n)){for(;o<s;){const e=createPacket(t,l,o);o++;return e}o=0}}c=0}l=0}throw new JpxError("Out of packets")}}function PositionComponentResolutionLayerIterator(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=i.codingStyleDefaultParameters.layersCount,r=t.Csiz,o=getPrecinctSizesInImageScale(i),a=o;let c=0,l=0,h=0,d=0,f=0;this.nextPacket=function JpxImage_nextPacket(){for(;f<a.maxNumHigh;f++){for(;d<a.maxNumWide;d++){for(;h<r;h++){const e=i.components[h],t=e.codingStyleParameters.decompositionLevelsCount;for(;l<=t;l++){const t=e.resolutions[l],n=o.components[h].resolutions[l],i=getPrecinctIndexIfExist(d,f,n,a,t);if(null!==i){for(;c<s;){const e=createPacket(t,i,c);c++;return e}c=0}}l=0}h=0}d=0}throw new JpxError("Out of packets")}}function ComponentPositionResolutionLayerIterator(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=i.codingStyleDefaultParameters.layersCount,r=t.Csiz,o=getPrecinctSizesInImageScale(i);let a=0,c=0,l=0,h=0,d=0;this.nextPacket=function JpxImage_nextPacket(){for(;l<r;++l){const e=i.components[l],t=o.components[l],n=e.codingStyleParameters.decompositionLevelsCount;for(;d<t.maxNumHigh;d++){for(;h<t.maxNumWide;h++){for(;c<=n;c++){const n=e.resolutions[c],i=t.resolutions[c],r=getPrecinctIndexIfExist(h,d,i,t,n);if(null!==r){for(;a<s;){const e=createPacket(n,r,a);a++;return e}a=0}}c=0}h=0}d=0}throw new JpxError("Out of packets")}}function getPrecinctIndexIfExist(e,t,n,i,s){const r=e*i.minWidth,o=t*i.minHeight;if(r%n.width!=0||o%n.height!=0)return null;const a=o/n.width*s.precinctParameters.numprecinctswide;return r/n.height+a}function getPrecinctSizesInImageScale(e){const t=e.components.length;let n=Number.MAX_VALUE,i=Number.MAX_VALUE,s=0,r=0;const o=new Array(t);for(let a=0;a<t;a++){const t=e.components[a],c=t.codingStyleParameters.decompositionLevelsCount,l=new Array(c+1);let h=Number.MAX_VALUE,d=Number.MAX_VALUE,f=0,u=0,m=1;for(let e=c;e>=0;--e){const n=t.resolutions[e],i=m*n.precinctParameters.precinctWidth,s=m*n.precinctParameters.precinctHeight;h=Math.min(h,i);d=Math.min(d,s);f=Math.max(f,n.precinctParameters.numprecinctswide);u=Math.max(u,n.precinctParameters.numprecinctshigh);l[e]={width:i,height:s};m<<=1}n=Math.min(n,h);i=Math.min(i,d);s=Math.max(s,f);r=Math.max(r,u);o[a]={resolutions:l,minWidth:h,minHeight:d,maxNumWide:f,maxNumHigh:u}}return{components:o,minWidth:n,minHeight:i,maxNumWide:s,maxNumHigh:r}}function buildPackets(e){const t=e.SIZ,n=e.currentTile.index,i=e.tiles[n],s=t.Csiz;for(let e=0;e<s;e++){const t=i.components[e],n=t.codingStyleParameters.decompositionLevelsCount,s=[],r=[];for(let e=0;e<=n;e++){const i=getBlocksDimensions(0,t,e),o={},a=1<<n-e;o.trx0=Math.ceil(t.tcx0/a);o.try0=Math.ceil(t.tcy0/a);o.trx1=Math.ceil(t.tcx1/a);o.try1=Math.ceil(t.tcy1/a);o.resLevel=e;buildPrecincts(0,o,i);s.push(o);let c;if(0===e){c={};c.type="LL";c.tbx0=Math.ceil(t.tcx0/a);c.tby0=Math.ceil(t.tcy0/a);c.tbx1=Math.ceil(t.tcx1/a);c.tby1=Math.ceil(t.tcy1/a);c.resolution=o;buildCodeblocks(0,c,i);r.push(c);o.subbands=[c]}else{const s=1<<n-e+1,a=[];c={};c.type="HL";c.tbx0=Math.ceil(t.tcx0/s-.5);c.tby0=Math.ceil(t.tcy0/s);c.tbx1=Math.ceil(t.tcx1/s-.5);c.tby1=Math.ceil(t.tcy1/s);c.resolution=o;buildCodeblocks(0,c,i);r.push(c);a.push(c);c={};c.type="LH";c.tbx0=Math.ceil(t.tcx0/s);c.tby0=Math.ceil(t.tcy0/s-.5);c.tbx1=Math.ceil(t.tcx1/s);c.tby1=Math.ceil(t.tcy1/s-.5);c.resolution=o;buildCodeblocks(0,c,i);r.push(c);a.push(c);c={};c.type="HH";c.tbx0=Math.ceil(t.tcx0/s-.5);c.tby0=Math.ceil(t.tcy0/s-.5);c.tbx1=Math.ceil(t.tcx1/s-.5);c.tby1=Math.ceil(t.tcy1/s-.5);c.resolution=o;buildCodeblocks(0,c,i);r.push(c);a.push(c);o.subbands=a}}t.resolutions=s;t.subbands=r}const r=i.codingStyleDefaultParameters.progressionOrder;switch(r){case 0:i.packetsIterator=new LayerResolutionComponentPositionIterator(e);break;case 1:i.packetsIterator=new ResolutionLayerComponentPositionIterator(e);break;case 2:i.packetsIterator=new ResolutionPositionComponentLayerIterator(e);break;case 3:i.packetsIterator=new PositionComponentResolutionLayerIterator(e);break;case 4:i.packetsIterator=new ComponentPositionResolutionLayerIterator(e);break;default:throw new JpxError(`Unsupported progression order ${r}`)}}function parseTilePackets(e,t,n,i){let s,r=0,o=0,a=!1;function readBits(e){for(;o<e;){const e=t[n+r];r++;if(a){s=s<<7|e;o+=7;a=!1}else{s=s<<8|e;o+=8}255===e&&(a=!0)}o-=e;return s>>>o&(1<<e)-1}function skipMarkerIfEqual(e){if(255===t[n+r-1]&&t[n+r]===e){skipBytes(1);return!0}if(255===t[n+r]&&t[n+r+1]===e){skipBytes(2);return!0}return!1}function skipBytes(e){r+=e}function alignToByte(){o=0;if(a){r++;a=!1}}function readCodingpasses(){if(0===readBits(1))return 1;if(0===readBits(1))return 2;let e=readBits(2);if(e<3)return e+3;e=readBits(5);if(e<31)return e+6;e=readBits(7);return e+37}const c=e.currentTile.index,l=e.tiles[c],h=e.COD.sopMarkerUsed,d=e.COD.ephMarkerUsed,f=l.packetsIterator;for(;r<i;){alignToByte();h&&skipMarkerIfEqual(145)&&skipBytes(4);const e=f.nextPacket();if(!readBits(1))continue;const i=e.layerNumber,s=[];let o;for(let t=0,n=e.codeblocks.length;t<n;t++){o=e.codeblocks[t];let n=o.precinct;const r=o.cbx-n.cbxMin,a=o.cby-n.cbyMin;let c,l,h=!1,d=!1;if(void 0!==o.included)h=!!readBits(1);else{n=o.precinct;let e;if(void 0!==n.inclusionTree)e=n.inclusionTree;else{const t=n.cbxMax-n.cbxMin+1,s=n.cbyMax-n.cbyMin+1;e=new InclusionTree(t,s,i);l=new TagTree(t,s);n.inclusionTree=e;n.zeroBitPlanesTree=l;for(let e=0;e<i;e++)if(0!==readBits(1))throw new JpxError("Invalid tag tree")}if(e.reset(r,a,i))for(;;){if(!readBits(1)){e.incrementValue(i);break}c=!e.nextLevel();if(c){o.included=!0;h=d=!0;break}}}if(!h)continue;if(d){l=n.zeroBitPlanesTree;l.reset(r,a);for(;;)if(readBits(1)){c=!l.nextLevel();if(c)break}else l.incrementValue();o.zeroBitPlanes=l.value}const f=readCodingpasses();for(;readBits(1);)o.Lblock++;const u=log2(f),m=readBits((f<1<<u?u-1:u)+o.Lblock);s.push({codeblock:o,codingpasses:f,dataLength:m})}alignToByte();d&&skipMarkerIfEqual(146);for(;s.length>0;){const e=s.shift();o=e.codeblock;void 0===o.data&&(o.data=[]);o.data.push({data:t,start:n+r,end:n+r+e.dataLength,codingpasses:e.codingpasses});r+=e.dataLength}}return r}function copyCoefficients(e,t,n,i,s,r,o,a,c){const l=i.tbx0,h=i.tby0,d=i.tbx1-i.tbx0,f=i.codeblocks,u="H"===i.type.charAt(0)?1:0,m="H"===i.type.charAt(1)?t:0;for(let n=0,g=f.length;n<g;++n){const g=f[n],p=g.tbx1_-g.tbx0_,b=g.tby1_-g.tby0_;if(0===p||0===b)continue;if(void 0===g.data)continue;const x=new BitModel(p,b,g.subbandType,g.zeroBitPlanes,r);let w=2;const y=g.data;let k,C,I,B=0,P=0;for(k=0,C=y.length;k<C;k++){I=y[k];B+=I.end-I.start;P+=I.codingpasses}const T=new Uint8Array(B);let S=0;for(k=0,C=y.length;k<C;k++){I=y[k];const e=I.data.subarray(I.start,I.end);T.set(e,S);S+=e.length}const L=new ArithmeticDecoder(T,0,B);x.setDecoder(L);for(k=0;k<P;k++){switch(w){case 0:x.runSignificancePropagationPass();break;case 1:x.runMagnitudeRefinementPass();break;case 2:x.runCleanupPass();a&&x.checkSegmentationSymbol()}c&&x.reset();w=(w+1)%3}let v=g.tbx0_-l+(g.tby0_-h)*d;const M=x.coefficentsSign,_=x.coefficentsMagnitude,D=x.bitsDecoded,E=o?0:.5;let U,A,O;S=0;const R="LL"!==i.type;for(k=0;k<b;k++){const n=2*(v/d|0)*(t-d)+u+m;for(U=0;U<p;U++){A=_[S];if(0!==A){A=(A+E)*s;0!==M[S]&&(A=-A);O=D[S];e[R?n+(v<<1):v]=o&&O>=r?A:A*(1<<r-O)}v++;S++}v+=d-p}}}function transformTile(e,t,n){const i=t.components[n],s=i.codingStyleParameters,r=i.quantizationParameters,o=s.decompositionLevelsCount,a=r.SPqcds,c=r.scalarExpounded,l=r.guardBits,h=s.segmentationSymbolUsed,d=s.resetContextProbabilities,f=e.components[n].precision,u=s.reversibleTransformation,m=u?new ReversibleTransform:new IrreversibleTransform,g=[];let p=0;for(let e=0;e<=o;e++){const t=i.resolutions[e],n=t.trx1-t.trx0,s=t.try1-t.try0,r=new Float32Array(n*s);for(let i=0,s=t.subbands.length;i<s;i++){let s,o;if(c){s=a[p].mu;o=a[p].epsilon;p++}else{s=a[0].mu;o=a[0].epsilon+(e>0?1-e:0)}const m=t.subbands[i],g=_[m.type];copyCoefficients(r,n,0,m,u?1:2**(f+g-o)*(1+s/2048),l+o-1,u,h,d)}g.push({width:n,height:s,items:r})}const b=m.calculate(g,i.tcx0,i.tcy0);return{left:i.tcx0,top:i.tcy0,width:b.width,height:b.height,items:b.items}}function initializeTile(e,t){const n=e.SIZ.Csiz,i=e.tiles[t];for(let t=0;t<n;t++){const n=i.components[t],s=void 0!==e.currentTile.QCC[t]?e.currentTile.QCC[t]:e.currentTile.QCD;n.quantizationParameters=s;const r=void 0!==e.currentTile.COC[t]?e.currentTile.COC[t]:e.currentTile.COD;n.codingStyleParameters=r}i.codingStyleDefaultParameters=e.currentTile.COD}class TagTree{constructor(e,t){const n=log2(Math.max(e,t))+1;this.levels=[];for(let i=0;i<n;i++){const n={width:e,height:t,items:[]};this.levels.push(n);e=Math.ceil(e/2);t=Math.ceil(t/2)}}reset(e,t){let n,i=0,s=0;for(;i<this.levels.length;){n=this.levels[i];const r=e+t*n.width;if(void 0!==n.items[r]){s=n.items[r];break}n.index=r;e>>=1;t>>=1;i++}i--;n=this.levels[i];n.items[n.index]=s;this.currentLevel=i;delete this.value}incrementValue(){const e=this.levels[this.currentLevel];e.items[e.index]++}nextLevel(){let e=this.currentLevel,t=this.levels[e];const n=t.items[t.index];e--;if(e<0){this.value=n;return!1}this.currentLevel=e;t=this.levels[e];t.items[t.index]=n;return!0}}class InclusionTree{constructor(e,t,n){const i=log2(Math.max(e,t))+1;this.levels=[];for(let s=0;s<i;s++){const i=new Uint8Array(e*t);for(let e=0,t=i.length;e<t;e++)i[e]=n;const s={width:e,height:t,items:i};this.levels.push(s);e=Math.ceil(e/2);t=Math.ceil(t/2)}}reset(e,t,n){let i=0;for(;i<this.levels.length;){const s=this.levels[i],r=e+t*s.width;s.index=r;const o=s.items[r];if(255===o)break;if(o>n){this.currentLevel=i;this.propagateValues();return!1}e>>=1;t>>=1;i++}this.currentLevel=i-1;return!0}incrementValue(e){const t=this.levels[this.currentLevel];t.items[t.index]=e+1;this.propagateValues()}propagateValues(){let e=this.currentLevel,t=this.levels[e];const n=t.items[t.index];for(;--e>=0;){t=this.levels[e];t.items[t.index]=n}}nextLevel(){let e=this.currentLevel,t=this.levels[e];const n=t.items[t.index];t.items[t.index]=255;e--;if(e<0)return!1;this.currentLevel=e;t=this.levels[e];t.items[t.index]=n;return!0}}class BitModel{static UNIFORM_CONTEXT=17;static RUNLENGTH_CONTEXT=18;static LLAndLHContextsLabel=new Uint8Array([0,5,8,0,3,7,8,0,4,7,8,0,0,0,0,0,1,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8,0,0,0,0,0,2,6,8,0,3,7,8,0,4,7,8]);static HLContextLabel=new Uint8Array([0,3,4,0,5,7,7,0,8,8,8,0,0,0,0,0,1,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8,0,0,0,0,0,2,3,4,0,6,7,7,0,8,8,8]);static HHContextLabel=new Uint8Array([0,1,2,0,1,2,2,0,2,2,2,0,0,0,0,0,3,4,5,0,4,5,5,0,5,5,5,0,0,0,0,0,6,7,7,0,7,7,7,0,7,7,7,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8,0,0,0,0,0,8,8,8,0,8,8,8,0,8,8,8]);constructor(e,t,n,i,s){this.width=e;this.height=t;let r;r="HH"===n?BitModel.HHContextLabel:"HL"===n?BitModel.HLContextLabel:BitModel.LLAndLHContextsLabel;this.contextLabelTable=r;const o=e*t;this.neighborsSignificance=new Uint8Array(o);this.coefficentsSign=new Uint8Array(o);let a;a=s>14?new Uint32Array(o):s>6?new Uint16Array(o):new Uint8Array(o);this.coefficentsMagnitude=a;this.processingFlags=new Uint8Array(o);const c=new Uint8Array(o);if(0!==i)for(let e=0;e<o;e++)c[e]=i;this.bitsDecoded=c;this.reset()}setDecoder(e){this.decoder=e}reset(){this.contexts=new Int8Array(19);this.contexts[0]=8;this.contexts[BitModel.UNIFORM_CONTEXT]=92;this.contexts[BitModel.RUNLENGTH_CONTEXT]=6}setNeighborsSignificance(e,t,n){const i=this.neighborsSignificance,s=this.width,r=this.height,o=t>0,a=t+1<s;let c;if(e>0){c=n-s;o&&(i[c-1]+=16);a&&(i[c+1]+=16);i[c]+=4}if(e+1<r){c=n+s;o&&(i[c-1]+=16);a&&(i[c+1]+=16);i[c]+=4}o&&(i[n-1]+=1);a&&(i[n+1]+=1);i[n]|=128}runSignificancePropagationPass(){const e=this.decoder,t=this.width,n=this.height,i=this.coefficentsMagnitude,s=this.coefficentsSign,r=this.neighborsSignificance,o=this.processingFlags,a=this.contexts,c=this.contextLabelTable,l=this.bitsDecoded;for(let h=0;h<n;h+=4)for(let d=0;d<t;d++){let f=h*t+d;for(let u=0;u<4;u++,f+=t){const t=h+u;if(t>=n)break;o[f]&=-2;if(i[f]||!r[f])continue;const m=c[r[f]];if(e.readBit(a,m)){const e=this.decodeSignBit(t,d,f);s[f]=e;i[f]=1;this.setNeighborsSignificance(t,d,f);o[f]|=2}l[f]++;o[f]|=1}}}decodeSignBit(e,t,n){const i=this.width,s=this.height,r=this.coefficentsMagnitude,o=this.coefficentsSign;let a,c,l,h,d,f;h=t>0&&0!==r[n-1];if(t+1<i&&0!==r[n+1]){l=o[n+1];if(h){c=o[n-1];a=1-l-c}else a=1-l-l}else if(h){c=o[n-1];a=1-c-c}else a=0;const u=3*a;h=e>0&&0!==r[n-i];if(e+1<s&&0!==r[n+i]){l=o[n+i];if(h){c=o[n-i];a=1-l-c+u}else a=1-l-l+u}else if(h){c=o[n-i];a=1-c-c+u}else a=u;if(a>=0){d=9+a;f=this.decoder.readBit(this.contexts,d)}else{d=9-a;f=1^this.decoder.readBit(this.contexts,d)}return f}runMagnitudeRefinementPass(){const e=this.decoder,t=this.width,n=this.height,i=this.coefficentsMagnitude,s=this.neighborsSignificance,r=this.contexts,o=this.bitsDecoded,a=this.processingFlags,c=t*n,l=4*t;for(let n,h=0;h<c;h=n){n=Math.min(c,h+l);for(let c=0;c<t;c++)for(let l=h+c;l<n;l+=t){if(!i[l]||0!=(1&a[l]))continue;let t=16;if(0!=(2&a[l])){a[l]^=2;t=0===(127&s[l])?15:14}const n=e.readBit(r,t);i[l]=i[l]<<1|n;o[l]++;a[l]|=1}}}runCleanupPass(){const e=this.decoder,t=this.width,n=this.height,i=this.neighborsSignificance,s=this.coefficentsMagnitude,r=this.coefficentsSign,o=this.contexts,a=this.contextLabelTable,c=this.bitsDecoded,l=this.processingFlags,h=t,d=2*t,f=3*t;let u;for(let m=0;m<n;m=u){u=Math.min(m+4,n);const g=m*t,p=m+3<n;for(let n=0;n<t;n++){const b=g+n;let x,w=0,y=b,k=m;if(p&&0===l[b]&&0===l[b+h]&&0===l[b+d]&&0===l[b+f]&&0===i[b]&&0===i[b+h]&&0===i[b+d]&&0===i[b+f]){if(!e.readBit(o,BitModel.RUNLENGTH_CONTEXT)){c[b]++;c[b+h]++;c[b+d]++;c[b+f]++;continue}w=e.readBit(o,BitModel.UNIFORM_CONTEXT)<<1|e.readBit(o,BitModel.UNIFORM_CONTEXT);if(0!==w){k=m+w;y+=w*t}x=this.decodeSignBit(k,n,y);r[y]=x;s[y]=1;this.setNeighborsSignificance(k,n,y);l[y]|=2;y=b;for(let e=m;e<=k;e++,y+=t)c[y]++;w++}for(k=m+w;k<u;k++,y+=t){if(s[y]||0!=(1&l[y]))continue;const t=a[i[y]];if(1===e.readBit(o,t)){x=this.decodeSignBit(k,n,y);r[y]=x;s[y]=1;this.setNeighborsSignificance(k,n,y);l[y]|=2}c[y]++}}}}checkSegmentationSymbol(){const e=this.decoder,t=this.contexts;if(10!==(e.readBit(t,BitModel.UNIFORM_CONTEXT)<<3|e.readBit(t,BitModel.UNIFORM_CONTEXT)<<2|e.readBit(t,BitModel.UNIFORM_CONTEXT)<<1|e.readBit(t,BitModel.UNIFORM_CONTEXT)))throw new JpxError("Invalid segmentation symbol")}}class Transform{constructor(){this.constructor===Transform&&util_unreachable("Cannot initialize Transform.")}calculate(e,t,n){let i=e[0];for(let s=1,r=e.length;s<r;s++)i=this.iterate(i,e[s],t,n);return i}extend(e,t,n){let i=t-1,s=t+1,r=t+n-2,o=t+n;e[i--]=e[s++];e[o++]=e[r--];e[i--]=e[s++];e[o++]=e[r--];e[i--]=e[s++];e[o++]=e[r--];e[i]=e[s];e[o]=e[r]}filter(e,t,n){util_unreachable("Abstract method `filter` called")}iterate(e,t,n,i){const s=e.width,r=e.height;let o=e.items;const a=t.width,c=t.height,l=t.items;let h,d,f,u,m,g;for(f=0,h=0;h<r;h++){u=2*h*a;for(d=0;d<s;d++,f++,u+=2)l[u]=o[f]}o=e.items=null;const p=new Float32Array(a+8);if(1===a){if(0!=(1&n))for(g=0,f=0;g<c;g++,f+=a)l[f]*=.5}else for(g=0,f=0;g<c;g++,f+=a){p.set(l.subarray(f,f+a),4);this.extend(p,4,a);this.filter(p,4,a);l.set(p.subarray(4,4+a),f)}let b=16;const x=[];for(h=0;h<b;h++)x.push(new Float32Array(c+8));let w,y=0;e=4+c;if(1===c){if(0!=(1&i))for(m=0;m<a;m++)l[m]*=.5}else for(m=0;m<a;m++){if(0===y){b=Math.min(a-m,b);for(f=m,u=4;u<e;f+=a,u++)for(w=0;w<b;w++)x[w][u]=l[f+w];y=b}y--;const t=x[y];this.extend(t,4,c);this.filter(t,4,c);if(0===y){f=m-b+1;for(u=4;u<e;f+=a,u++)for(w=0;w<b;w++)l[f+w]=x[w][u]}}return{width:a,height:c,items:l}}}class IrreversibleTransform extends Transform{filter(e,t,n){const i=n>>1;let s,r,o,a;const c=-1.586134342059924,l=-.052980118572961,h=.882911075530934,d=.443506852043971,f=1.230174104914001;s=(t|=0)-3;for(r=i+4;r--;s+=2)e[s]*=.8128930661159609;s=t-2;o=d*e[s-1];for(r=i+3;r--;s+=2){a=d*e[s+1];e[s]=f*e[s]-o-a;if(!r--)break;s+=2;o=d*e[s+1];e[s]=f*e[s]-o-a}s=t-1;o=h*e[s-1];for(r=i+2;r--;s+=2){a=h*e[s+1];e[s]-=o+a;if(!r--)break;s+=2;o=h*e[s+1];e[s]-=o+a}s=t;o=l*e[s-1];for(r=i+1;r--;s+=2){a=l*e[s+1];e[s]-=o+a;if(!r--)break;s+=2;o=l*e[s+1];e[s]-=o+a}if(0!==i){s=t+1;o=c*e[s-1];for(r=i;r--;s+=2){a=c*e[s+1];e[s]-=o+a;if(!r--)break;s+=2;o=c*e[s+1];e[s]-=o+a}}}}class ReversibleTransform extends Transform{filter(e,t,n){const i=n>>1;let s,r;for(s=t|=0,r=i+1;r--;s+=2)e[s]-=e[s-1]+e[s+1]+2>>2;for(s=t+1,r=i;r--;s+=2)e[s]+=e[s-1]+e[s+1]>>1}}var D=t.Jbig2Image,E=t.JpegImage,U=t.JpxImage,A=t.getVerbosityLevel,O=t.setVerbosityLevel;export{D as Jbig2Image,E as JpegImage,U as JpxImage,A as getVerbosityLevel,O as setVerbosityLevel};