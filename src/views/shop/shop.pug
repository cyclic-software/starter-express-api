extends ../base

block content
    div(style="width: 32rem;").card-detail
        img(src="/" + item.itemImg alt="logo" height="300").card-img-top
        div.card-body
            h5.card-title=item.name
            p.card-text=item.content
            strong.card-text #{item.amount}ì›
            br
            br
            form(method="POST")
                br
                span ë¬´ë‹¨ ë°°í¬ë¥¼ í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤
                input(id="check" type="checkbox" name="check" value="true" checked)
                br
                br
                a(href="/shop/list") &larr;ë’¤ë¡œê°€ê¸°
                |&nbsp;&nbsp;&nbsp;
                input(onclick="requestPay()" value="ê²°ì œí•˜ê¸°").btn.btn-primary
                span.no-account ë¬´í†µì¥ ì…ê¸ˆğŸ’°
                    input(id="noAccount" type="checkbox")
                
    script.
        const check = document.getElementById("check");
        const noAccountCheck = document.getElementById("noAccount");
        function requestPay() {
        if(!check.checked) {
            alert("ë¬´ë‹¨ ë°°í¬ì— ëŒ€í•œ ë™ì˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”");
            return;
        }
        if(#{!loggedIn}) {
            alert("ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš” ê°ì‚¬í•©ë‹ˆë‹¤ :)");
            return;
        }
   
            const IMP = window.IMP;
            IMP.init("#{shopPidCode}");
            IMP.request_pay({
                pg: "daou", // PGì‚¬ ì„ íƒ html5_inicis
                pay_method: `${!noAccountCheck.checked ? 'card' : 'vbank'}`, // ì§€ë¶ˆ ìˆ˜ë‹¨ vbank "ê°€ìƒê³„ì¢Œ" //-> https://docs.iamport.kr/sdk/javascript-sdk
                merchant_uid: `merchant_#{Date.now()}`, //ê°€ë§¹ì ì—ì„œ êµ¬ë³„í•  ìˆ˜ ìˆëŠ” ê³ ìœ í•œid
                name: `#{item.name}`, // ìƒí’ˆëª…
                amount: `#{item.amount}`, // ê°€ê²©
                buyer_email: `#{loggedInUser.email}`,
                buyer_name: `#{loggedInUser.name}`, // êµ¬ë§¤ì ì´ë¦„
                buyer_tel: "", // êµ¬ë§¤ì ì—°ë½ì²˜ 
                buyer_addr: `#{loggedInUser.region}`,// êµ¬ë§¤ì ì£¼ì†Œì§€
                buyer_postcode: "", // êµ¬ë§¤ì ìš°í¸ë²ˆí˜¸
                m_redirect_url : '', // ëª¨ë°”ì¼ ê²°ì œì‹œ ì‚¬ìš©í•  url
                digital: true, // ì‹¤ì œ ë¬¼í’ˆì¸ì§€ ë¬´í˜•ì˜ ìƒí’ˆì¸ì§€(í•¸ë“œí° ê²°ì œì—ì„œ í•„ìˆ˜ íŒŒë¼ë¯¸í„°)
                app_scheme : '' // ëŒì•„ì˜¬ app scheme
            }, async function (rsp) { // callback
                if (rsp.success) { // ê²°ì œ ì„±ê³µ ì‹œ: ê²°ì œ ìŠ¹ì¸ ë˜ëŠ” ê°€ìƒê³„ì¢Œ ë°œê¸‰ì— ì„±ê³µí•œ ê²½ìš°
                    // jQueryë¡œ HTTP ìš”ì²­
                    const data = await(
                        await fetch("#{isHeroku ? domain : devDomain}/shop/success",
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body : JSON.stringify({
                                    imp_uid: rsp.imp_uid,
                                    merchant_uid: rsp.merchant_uid,
                                    id:"#{item._id}"
                                })
                            }
                    )).json();
                    console.log(data);
                    try {
                        switch(data.status) {
                            case "vbankIssued":
                                // ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì‹œ ë¡œì§
                                const {vbank_date,vbank_name,vbank_num} = data;
                                sessionStorage.setItem("bank",JSON.stringify({vbank_date,vbank_name,vbank_num}));
                                window.location.href = "/shop/success";
                            break;
                            case "success":
                                // ê²°ì œ ì„±ê³µ ì‹œ ë¡œì§
                                window.location.href = "/shop/success";
                            break;
                        }
                    }  catch (error) {
                        console.log(error);
                    }
                    
                } else {
                    alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " +  rsp.error_msg );
                }
            }); 
        }